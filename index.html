<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>è£…ä¿®è®°è´¦ Â· AIæ™ºèƒ½è¯­éŸ³ Â· é¡¹ç›®/æ—¶é—´ç­›é€‰</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* ========== é»‘è‰²æç®€ä¸»ä¹‰ Â· ç§»åŠ¨ä¼˜å…ˆ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        body {
            background-color: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 16px 100px;
        }

        /* å¤´éƒ¨ - å·²å½»åº•ç§»é™¤å³ä¸Šè§’åŠ å· */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0 20px;
            border-bottom: 1px solid #2a2a2a;
            margin-bottom: 24px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 1px;
        }
        .header h1 span {
            color: #00d4aa;
            font-weight: 600;
        }

        /* ===== å¤åˆç­›é€‰æ ï¼šæ—¶é—´ + é¡¹ç›®æœç´¢ï¼ˆæç®€èåˆï¼‰===== */
        .filter-section {
            display: flex;
            align-items: center;
            width: 100%;
            margin-bottom: 12px;
            position: relative;
        }

        .time-filter-container {
            position: relative;
            flex-shrink: 0;
        }

        .time-filter-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 16px;
            height: 48px;
            background: #161616;
            border: 1px solid #2a2a2a;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.2s;
            color: #e0e0e0;
            font-size: 14px;
            white-space: nowrap;
        }

        .time-filter-btn:hover {
            border-color: #00d4aa;
            background: #1e1e1e;
        }

        .time-filter-btn i:first-child {
            font-size: 15px;
        }

        .time-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            width: 180px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            z-index: 1001;
            display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            padding: 8px 0;
        }

        .time-dropdown.active {
            display: block;
        }

        .time-dropdown-item {
            padding: 10px 16px;
            color: #e0e0e0;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-dropdown-item:hover {
            background: #252525;
            color: #00d4aa;
        }

        .time-dropdown-item.active {
            background: #00d4aa20;
            color: #00d4aa;
            border-left: 3px solid #00d4aa;
        }

        .time-dropdown-divider {
            height: 1px;
            background: #2a2a2a;
            margin: 8px 0;
        }

        /* è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´å¼¹å±‚ */
        .custom-date-range {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            width: 280px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            z-index: 1002;
            padding: 16px;
            display: none;
        }

        .custom-date-range.active {
            display: block;
        }

        .custom-date-range .date-input {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .custom-date-range input {
            flex: 1;
            background: #262626;
            border: 1px solid #3a3a3a;
            border-radius: 12px;
            padding: 10px 12px;
            color: white;
            font-size: 13px;
        }

        .custom-date-range .apply-btn {
            width: 100%;
            background: #00d4aa;
            color: #0a0a0a;
            border: none;
            border-radius: 20px;
            padding: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        /* æœç´¢å®¹å™¨ - å³ä¾§å¼¹æ€§æ‰©å±• */
        .search-container {
            position: relative;
            flex: 1;
            margin-left: 12px;
            border: 1px solid #2a2a2a;
            border-radius: 40px;
            background: #161616;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            height: 48px;
            box-sizing: border-box;
        }
        .search-container:focus-within {
            border-color: #00d4aa;
            box-shadow: 0 0 0 2px rgba(0,212,170,0.1);
        }
        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 20px;
            padding-right: 50px;
            color: #ffffff;
            font-size: 15px;
            outline: none;
            border-radius: 40px;
        }
        .search-input::placeholder {
            color: #666;
            font-weight: 300;
        }
        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #00d4aa;
            font-size: 16px;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: rgba(0,212,170,0.1);
            border-radius: 50%;
        }
        .search-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            width: 100%;
            max-height: 280px;
            overflow-y: auto;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            padding: 8px 0;
        }
        .search-dropdown.active {
            display: block;
        }
        .dropdown-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
            color: #e0e0e0;
            font-size: 14px;
        }
        .dropdown-item:hover {
            background: #252525;
        }
        .dropdown-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #00d4aa;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
        }
        .dropdown-item label {
            flex: 1;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .project-budget-badge {
            font-size: 12px;
            color: #00d4aa;
            background: rgba(0,212,170,0.1);
            padding: 2px 8px;
            border-radius: 12px;
        }
        .dropdown-actions {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #2a2a2a;
            margin-bottom: 4px;
        }
        .dropdown-action-btn {
            background: transparent;
            border: 1px solid #3a3a3a;
            color: #b0b0b0;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: 0.2s;
        }
        .dropdown-action-btn:hover {
            border-color: #00d4aa;
            color: #00d4aa;
            background: rgba(0,212,170,0.05);
        }
        .dropdown-empty {
            padding: 20px;
            text-align: center;
            color: #777;
            font-size: 14px;
        }

        /* å·²é€‰æ ‡ç­¾åŒºï¼šæ—¶é—´æ ‡ç­¾ + é¡¹ç›®æ ‡ç­¾ å¹³çº§å±•ç¤º */
        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            min-height: 32px;
        }
        .selected-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #1e2a2a;
            border: 1px solid #00d4aa40;
            border-radius: 20px;
            font-size: 13px;
            color: #00d4aa;
            transition: all 0.2s;
        }
        .selected-tag:hover {
            background: #00d4aa20;
            border-color: #00d4aa;
        }
        .selected-tag .remove-tag {
            cursor: pointer;
            font-size: 14px;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            color: #ff6b6b;
        }
        .selected-tag .remove-tag:hover {
            background: #ff6b6b;
            color: #fff;
        }
        /* æ—¶é—´æ ‡ç­¾ - åŒºåˆ«äºé¡¹ç›®æ ‡ç­¾çš„é»„è‰²ç³» */
        .time-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #1e2a2a;
            border: 1px solid #ffd93d40;
            border-radius: 20px;
            font-size: 13px;
            color: #ffd93d;
        }
        .time-tag i {
            font-size: 12px;
            color: #ffd93d;
        }
        .time-tag .remove-tag {
            cursor: pointer;
            font-size: 14px;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            color: #ff6b6b;
        }
        .time-tag .remove-tag:hover {
            background: #ff6b6b;
            color: #fff;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .filter-section {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            .time-filter-btn {
                height: 44px;
                justify-content: center;
            }
            .search-container {
                margin-left: 0 !important;
                height: 44px;
            }
            .search-input {
                padding: 10px 16px;
                padding-right: 45px;
                font-size: 14px;
            }
            .time-dropdown {
                width: 100%;
            }
            .custom-date-range {
                width: 100%;
            }
        }

        /* ===== ä»ªè¡¨ç›˜ Â· å…­å¡å¸ƒå±€ ===== */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 28px;
        }
        @media (min-width: 1024px) {
            .dashboard {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        .dashboard-card {
            background: #161616;
            border-radius: 16px;
            padding: 18px 14px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.3);
        }
        .dashboard-card h3 {
            font-size: 14px;
            font-weight: 400;
            color: #a0a0a0;
            margin-bottom: 8px;
        }
        .dashboard-card .value {
            font-size: 24px;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 4px;
            word-break: break-word;
        }
        .dashboard-card .profit { color: #00d4aa; }
        .dashboard-card .loss { color: #ff6b6b; }
        .dashboard-card .warning { color: #ffd93d; }
        .dashboard-card .subtext {
            font-size: 12px;
            color: #8a8a8a;
        }

        /* åº”æ”¶è´¦æ¬¾æ¨¡å— */
        .receivable-section {
            background: #161616;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #ffd93d40;
            box-shadow: 0 8px 20px rgba(255,217,61,0.1);
        }
        .receivable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .receivable-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #ffd93d;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .receivable-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .receivable-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .receivable-card { padding: 12px 16px; }
            .receivable-card h4 { font-size: 12px; margin-bottom: 4px; }
            .receivable-card .amount { font-size: 20px; margin-bottom: 2px; }
            .receivable-card .count { font-size: 11px; }
        }
        .receivable-card {
            background: #1e1e1e;
            border-radius: 16px;
            padding: 16px;
            border-left: 4px solid;
        }
        .receivable-card.overdue { border-left-color: #ff6b6b; }
        .receivable-card.upcoming { border-left-color: #ffd93d; }
        .receivable-card h4 {
            font-size: 13px;
            color: #b0b0b0;
            margin-bottom: 8px;
        }
        .receivable-card .amount {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .receivable-card .amount.overdue { color: #ff6b6b; }
        .receivable-card .amount.upcoming { color: #ffd93d; }
        .receivable-card .count {
            font-size: 12px;
            color: #8a8a8a;
        }
        .receivable-table-container {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 12px;
            background: #1a1a1a;
        }
        .receivable-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .receivable-table th {
            color: #b0b0b0;
            font-weight: 400;
            text-align: left;
            padding: 14px 12px;
            border-bottom: 1px solid #333;
            background: #1a1a1a;
            position: sticky;
            top: 0;
        }
        .receivable-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #2a2a2a;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-overdue { background: #ff6b6b20; color: #ff6b6b; border: 1px solid #ff6b6b; }
        .status-upcoming { background: #ffd93d20; color: #ffd93d; border: 1px solid #ffd93d; }
        .status-normal { background: #00d4aa20; color: #00d4aa; border: 1px solid #00d4aa; }
        .status-paid { background: #4dabf720; color: #4dabf7; border: 1px solid #4dabf7; }

        /* åŒå›¾è¡¨å¸ƒå±€ */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (min-width: 1024px) {
            .charts-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        .chart-box {
            background: #161616;
            border-radius: 20px;
            padding: 16px;
            position: relative;
            width: 100%;
            height: 320px;
            overflow: hidden;
        }
        @media (max-width: 768px) {
            .chart-box { height: 260px; }
        }
        .chart-box h3 {
            font-size: 16px;
            color: #ccc;
            margin-bottom: 12px;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* å³ä¸Šè§’æ¯›åˆ©æ¶¦æ€»é¢æ ‡æ³¨ï¼ˆé»„è‰²ï¼‰ */
        .profit-corner-label {
            position: absolute;
            top: 10px;
            right: 20px;
            color: #ffd93d;
            background: rgba(255, 217, 61, 0.1);
            border: 1px solid #ffd93d;
            border-radius: 20px;
            padding: 8px 18px;
            font-size: 15px;
            font-weight: 600;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(255, 217, 61, 0.2);
            backdrop-filter: blur(4px);
            letter-spacing: 0.5px;
        }

        /* è¡¨æ ¼åŒºåŸŸ */
        .table-container {
            background: #161616;
            border-radius: 24px;
            padding: 20px 16px;
            margin-bottom: 20px;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .table-title-area {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .btn-export {
            background: transparent;
            color: #00d4aa;
            border: 1px solid #00d4aa;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-export:hover {
            background: #00d4aa;
            color: #0a0a0a;
        }
        .table-tabs {
            display: flex;
            gap: 8px;
            background: #252525;
            padding: 4px;
            border-radius: 30px;
        }
        .tab-btn {
            background: transparent;
            border: none;
            color: #aaa;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            transition: 0.2s;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #00d4aa;
            color: #0a0a0a;
            font-weight: 600;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .data-table th {
            color: #a0a0a0;
            font-weight: 400;
            text-align: left;
            padding: 12px 6px 6px;
            border-bottom: 1px solid #333;
        }
        .data-table td {
            padding: 12px 6px;
            border-bottom: 1px solid #2a2a2a;
        }
        .profit-cell { color: #00d4aa; }
        .loss-cell { color: #ff6b6b; }
        .warning-cell { color: #ffd93d; }
        .action-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .btn-edit, .btn-delete {
            background: transparent;
            border: 1px solid;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
        }
        .btn-edit { color: #4dabf7; border-color: #4dabf7; }
        .btn-delete { color: #ff6b6b; border-color: #ff6b6b; }

        /* ===== æç®€æµ®åŠ¨æŒ‰é’®èœå• ===== */
        .fab-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .fab-transaction {
            width: 70px;
            height: 70px;
            background: #00d4aa;
            border: none;
            border-radius: 50%;
            color: #0a0a0a;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 8px 20px rgba(0,212,170,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            z-index: 1000;
        }

        .fab-transaction:hover {
            transform: scale(1.1);
        }

        .fab-menu {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 180px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 8px 0;
            display: none;
            flex-direction: column;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            backdrop-filter: blur(8px);
        }

        .fab-menu.active {
            display: flex;
        }

        .fab-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-size: 15px;
            cursor: pointer;
            transition: 0.2s;
            text-align: left;
        }

        .fab-menu-item:hover {
            background: #252525;
            color: #00d4aa;
        }

        .fab-menu-item i {
            width: 20px;
            color: #00d4aa;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .fab-container {
                bottom: 20px;
                right: 20px;
            }
            .fab-transaction {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            .fab-menu {
                bottom: 70px;
                width: 160px;
            }
            .fab-menu-item {
                padding: 12px 16px;
                font-size: 14px;
            }
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a1a;
            width: 92%;
            max-width: 500px;
            border-radius: 28px;
            padding: 28px 24px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .modal-header h2 { font-size: 22px; font-weight: 500; }
        .btn-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 28px;
            cursor: pointer;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            color: #b0b0b0;
            margin-bottom: 6px;
            font-size: 15px;
        }
        .form-control {
            width: 100%;
            padding: 14px 16px;
            background: #262626;
            border: 1px solid #3a3a3a;
            border-radius: 14px;
            color: white;
            font-size: 16px;
        }
        .form-control:focus { border-color: #00d4aa; outline: none; }
        .btn-submit {
            background: #00d4aa;
            color: #0a0a0a;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 40px;
            font-weight: 700;
            font-size: 17px;
            margin-top: 10px;
            cursor: pointer;
        }
        .btn-submit:hover { background: #00b894; }

        /* æ”¶æ¬¾èŠ‚ç‚¹ */
        .milestone-section {
            margin-top: 20px;
            border-top: 1px solid #3a3a3a;
            padding-top: 20px;
        }
        .milestone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .milestone-header h4 { color: #00d4aa; font-size: 16px; }
        .btn-add-milestone {
            background: transparent;
            color: #00d4aa;
            border: 1px solid #00d4aa;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-add-milestone:hover {
            background: rgba(0,212,170,0.1);
        }
        .milestone-list { max-height: 300px; overflow-y: auto; }
        .milestone-item {
            background: #262626;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .milestone-info { flex: 1; }
        .milestone-date { color: #00d4aa; font-size: 14px; font-weight: 600; }
        .milestone-amount { color: #fff; font-size: 16px; font-weight: 700; margin-top: 4px; }
        .milestone-actions { display: flex; gap: 8px; }
        .btn-remove-milestone {
            background: transparent;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-remove-milestone:hover {
            background: rgba(255,107,107,0.1);
        }
        .milestone-total {
            margin-top: 12px;
            padding: 12px;
            background: #1e2a2a;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #00d4aa;
            font-weight: 600;
        }

        /* è¯­éŸ³è¾“å…¥ */
        .voice-hero {
            background: linear-gradient(145deg, #1e2a2a, #141818);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid #00d4aa40;
        }
        .voice-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #00d4aa;
            border: none;
            font-size: 28px;
            color: #0a0a0a;
            flex-shrink: 0;
            transition: 0.2s;
            cursor: pointer;
            box-shadow: 0 0 0 0 rgba(0,212,170,0.5);
        }
        .voice-btn.listening {
            background: #ff6b6b;
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 #ff6b6b; }
            70% { box-shadow: 0 0 0 14px #ff6b6b00; }
        }
        .voice-info { flex: 1; }
        .voice-info h4 { color: #00d4aa; font-size: 17px; margin-bottom: 5px; }
        .voice-info p { color: #b0b0b0; font-size: 13px; }
        .voice-status {
            margin-top: 8px;
            color: #ccc;
            font-size: 14px;
            min-height: 24px;
        }

        /* è´¹ç”¨ç±»å‹æ ‡ç­¾ */
        .category-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .category-tag {
            background: #2a2a2a;
            padding: 8px 18px;
            border-radius: 30px;
            font-size: 14px;
            color: #ddd;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .category-tag:hover {
            background: #3a3a3a;
            transform: translateY(-1px);
        }
        .category-tag.active {
            background: #00d4aa;
            color: #0a0a0a;
            font-weight: 600;
            border: 1px solid #00d4aa;
            box-shadow: 0 0 10px rgba(0,212,170,0.3);
        }
        .category-tag .remove-tag {
            font-size: 14px;
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
        }
        .category-tag:hover .remove-tag { background: rgba(255,255,255,0.2); }
        .custom-category-input {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .btn-add-category {
            background: #3a3a3a;
            border: none;
            border-radius: 20px;
            padding: 0 20px;
            color: white;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-add-category:hover { background: #4a4a4a; }

        /* è¯­éŸ³ç¡®è®¤æ¡† */
        .confirm-box {
            background: #1e1e1e;
            border-radius: 18px;
            padding: 20px;
            margin: 10px 0;
        }
        .voice-result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #333;
        }
        .voice-match-hint {
            background: #00d4aa20;
            border-left: 4px solid #00d4aa;
            padding: 12px;
            margin-top: 12px;
            border-radius: 8px;
            color: #ddd;
            font-size: 13px;
        }
       /* è¯­éŸ³ç¡®è®¤æŒ‰é’®å®¹å™¨ */
.confirm-buttons {
    display: flex;
    gap: 12px;
    margin-top: 28px;
}

/* ä¿®æ”¹æŒ‰é’® - ç°è‰²ç»ç’ƒ */
.btn-modify {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 40px;
    padding: 14px 20px;
    color: #e0e0e0;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-modify:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    color: #ffffff;
}

/* ç¡®è®¤å¹¶æäº¤æŒ‰é’® - é’ç»¿è‰²æ¸å˜ */
.btn-confirm {
    flex: 1;
    background: linear-gradient(145deg, #00d4aa, #00b894);
    border: none;
    border-radius: 40px;
    padding: 14px 20px;
    color: #0a0a0a;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
}

.btn-confirm:hover {
    background: linear-gradient(145deg, #00c49a, #00a87c);
    transform: translateY(-2px);
    box-shadow: 0 8px 18px rgba(0, 212, 170, 0.4);
}

.btn-confirm:active {
    transform: translateY(1px);
    box-shadow: 0 2px 8px rgba(0, 212, 170, 0.4);
}

/* å¯é€‰ï¼šæ·»åŠ  Font Awesome å›¾æ ‡ï¼ˆéœ€ç¡®ä¿æŒ‰é’® HTML ä¸­æœ‰ <i> æ ‡ç­¾ï¼‰ */
.btn-modify i, .btn-confirm i {
    font-size: 16px;
}
        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: #777;
        }

        /* ===== è¡¨æ ¼æ»šåŠ¨é˜²æº¢å‡º ===== */
        .table-scroll {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .table-scroll table {
            width: 100%;
            min-width: 720px;
            border-collapse: collapse;
        }
        .table-scroll th,
        .table-scroll td {
            padding: 8px 10px;
            font-size: 13px;
            line-height: 1.4;
            white-space: normal;
            word-break: break-word;
            text-align: left;
        }
        .table-scroll th { white-space: nowrap; font-weight: 600; }
        @media (max-width: 768px) {
            .table-scroll table { min-width: 640px; }
            .table-scroll th, .table-scroll td { padding: 6px 8px; font-size: 12px; }
        }

        /* ===== é¥¼å›¾å®¹å™¨å¼ºåˆ¶é™åˆ¶ ===== */
        #costPieChart {
            max-height: 220px !important;
            width: auto !important;
            margin: 0 auto;
            display: block;
        }
        .chart-box canvas {
            max-width: 100%;
            max-height: 100%;
            width: auto !important;
            height: auto !important;
        }
        @media (max-width: 768px) {
            #costPieChart { max-height: 180px !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ========== å¤´éƒ¨ ========= -->
        <div class="header">
            <h1>è£…ä¿®<span>è®°è´¦ Â· PROJECT AI</span></h1>
            <!-- å³ä¸Šè§’åŠ å·å·²å½»åº•åˆ é™¤ï¼Œæ›´æç®€ -->
        </div>

        <!-- ========== å¤åˆç­›é€‰æ ï¼šæ—¶é—´ç­›é€‰ + é¡¹ç›®æœç´¢ï¼ˆæç®€èåˆï¼‰========= -->
        <div class="filter-section">
            <div class="time-filter-container">
                <div class="time-filter-btn" id="timeFilterBtn">
                    <i class="fas fa-calendar-alt" style="color:#00d4aa;"></i>
                    <span id="timeFilterLabel">å…¨éƒ¨æ—¶é—´</span>
                    <i class="fas fa-chevron-down" style="font-size:12px; margin-left:4px; color:#888;"></i>
                </div>
                <div class="time-dropdown" id="timeDropdown">
                    <div class="time-dropdown-item active" data-value="all">ğŸ“… å…¨éƒ¨æ—¶é—´</div>
                    <div class="time-dropdown-item" data-value="today">ä»Šæ—¥</div>
                    <div class="time-dropdown-item" data-value="yesterday">æ˜¨æ—¥</div>
                    <div class="time-dropdown-item" data-value="week">è¿‘7å¤©</div>
                    <div class="time-dropdown-item" data-value="month">è¿‘30å¤©</div>
                    <div class="time-dropdown-item" data-value="quarter">è¿‘90å¤©</div>
                    <div class="time-dropdown-divider"></div>
                    <div class="time-dropdown-item" data-value="custom">ğŸ“† è‡ªå®šä¹‰</div>
                </div>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-input" id="projectSearchInput" placeholder="æœç´¢é¡¹ç›®...">
                <div class="search-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="search-dropdown" id="projectSearchDropdown"></div>
            </div>
        </div>

        <!-- å·²é€‰æ ‡ç­¾åŒºï¼šæ—¶é—´æ ‡ç­¾ + é¡¹ç›®æ ‡ç­¾ å¹³çº§å±•ç¤º -->
        <div class="selected-tags" id="selectedTagsArea"></div>

        <!-- ========== ä»ªè¡¨ç›˜ Â· å…­å¡ ========= -->
        <div class="dashboard">
            <div class="dashboard-card">
                <h3>ğŸ“¦ æ€»é¡¹ç›®</h3>
                <div class="value" id="totalProjects">0</div>
                <div class="subtext">è¿›è¡Œä¸­</div>
            </div>
            <div class="dashboard-card">
                <h3>ğŸ“‹ åˆåŒæ€»é¢</h3>
                <div class="value profit" id="totalContract">Â¥0</div>
                <div class="subtext">å…¨éƒ¨é¡¹ç›®é¢„ç®—</div>
            </div>
            <div class="dashboard-card">
                <h3>ğŸ’° æ€»æ”¶å…¥</h3>
                <div class="value profit" id="totalIncome">Â¥0</div>
                <div class="subtext">ç´¯è®¡å·²æ”¶</div>
            </div>
            <div class="dashboard-card">
                <h3>ğŸ“‰ æ€»æ”¯å‡º</h3>
                <div class="value loss" id="totalExpense">Â¥0</div>
                <div class="subtext">ç´¯è®¡æ”¯å‡º</div>
            </div>
            <div class="dashboard-card">
                <h3>ğŸ“Š æ¯›åˆ©æ¶¦æ€»é¢</h3>
                <div class="value profit" id="totalGrossProfit">Â¥0</div>
                <div class="subtext">åˆåŒé¢-æ”¯å‡º</div>
            </div>
            <div class="dashboard-card">
                <h3>âœ… æ¯›åˆ©æ¶¦(å·²ç»“ç®—)</h3>
                <div class="value profit" id="totalProfit">Â¥0</div>
                <div class="subtext">æ”¶å…¥-æ”¯å‡º</div>
            </div>
        </div>

        <!-- ========== åº”æ”¶è´¦æ¬¾æ¨¡å— ========= -->
        <div class="receivable-section">
            <div class="receivable-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> åº”æ”¶è´¦æ¬¾æé†’</h2>
                <span style="color:#ffd93d; font-size:14px;">å®æ—¶æ›´æ–°</span>
            </div>
            <div class="receivable-stats">
                <div class="receivable-card">
                    <h4>ğŸ“‹ å¾…æ”¶æ€»é¢</h4>
                    <div class="amount warning" id="totalReceivable">Â¥0</div>
                    <div class="count" id="totalReceivableCount">0ä¸ªé¡¹ç›®</div>
                </div>
                <div class="receivable-card overdue">
                    <h4>âš ï¸ é€¾æœŸé‡‘é¢</h4>
                    <div class="amount overdue" id="overdueAmount">Â¥0</div>
                    <div class="count" id="overdueCount">0ç¬”é€¾æœŸ</div>
                </div>
                <div class="receivable-card upcoming">
                    <h4>ğŸ“… å³å°†åˆ°æœŸ</h4>
                    <div class="amount upcoming" id="upcomingAmount">Â¥0</div>
                    <div class="count" id="upcomingCount">7å¤©å†…åˆ°æœŸ</div>
                </div>
            </div>
            <div class="receivable-table-container">
                <div class="table-scroll">
                    <table class="receivable-table data-table">
                        <thead>
                            <tr>
                                <th>é¡¹ç›®åç§°</th>
                                <th>æ”¶æ¬¾æ—¥æœŸ</th>
                                <th>åº”æ”¶é‡‘é¢</th>
                                <th>å·²æ”¶é‡‘é¢</th>
                                <th>å¾…æ”¶é‡‘é¢</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="receivableTableBody">
                            <tr><td colspan="6" class="empty-state"><i class="fas fa-file-invoice-dollar"></i><br>æš‚æ— åº”æ”¶è´¦æ¬¾</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========== åŒå›¾ ========= -->
        <div class="charts-container">
            <div class="chart-box" id="profitChartBox">
                <h3><i class="fas fa-chart-bar" style="color:#00d4aa;"></i> é¡¹ç›®åˆ©æ¶¦å¯¹æ¯”</h3>
                <canvas id="profitChart"></canvas>
            </div>
            <div class="chart-box">
                <h3><i class="fas fa-chart-pie" style="color:#ffd93d;"></i> æˆæœ¬ç±»å‹å æ¯”</h3>
                <canvas id="costPieChart"></canvas>
            </div>
        </div>

        <!-- ========== ä¸‰åˆä¸€æ™ºèƒ½è¡¨æ ¼ ========= -->
        <div class="table-container">
            <div class="table-header">
                <div class="table-title-area">
                    <div style="font-size:18px; font-weight:500;" id="tableTitle">ğŸ“‹ ç»¼åˆæŠ¥è¡¨</div>
                    <button class="btn-export" id="exportBtn"><i class="fas fa-file-excel"></i> å¯¼å‡ºExcel</button>
                </div>
                <div class="table-tabs">
                    <button class="tab-btn active" id="summaryToggle">ç»¼åˆ</button>
                    <button class="tab-btn" id="projectsToggle">é¡¹ç›®</button>
                    <button class="tab-btn" id="transactionsToggle">æ”¶æ”¯</button>
                </div>
            </div>
            <div class="table-scroll">
                <table class="data-table" id="summaryTable">
                    <thead><tr><th>é¡¹ç›®</th><th>åˆåŒæ€»é¢</th><th>å·²æ”¶</th><th>å¾…æ”¶</th><th>æ”¯å‡º</th><th>åˆ©æ¶¦</th><th>æ¯›åˆ©ç‡</th></tr></thead>
                    <tbody id="summaryTableBody"><tr><td colspan="7" class="empty-state"><i class="fas fa-chart-line"></i><br>æš‚æ— é¡¹ç›®</td></tr></tbody>
                </table>
            </div>
            <div class="table-scroll" id="projectsTableWrap" style="display:none;">
                <table class="data-table" id="projectsTable">
                    <thead><tr><th>é¡¹ç›®åç§°</th><th>åˆåŒæ€»é¢</th><th>æ”¶æ¬¾èŠ‚ç‚¹</th><th>å·²æ”¶</th><th>å¾…æ”¶</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="projectsTableBody"></tbody>
                </table>
            </div>
            <div class="table-scroll" id="transactionsTableWrap" style="display:none;">
                <table class="data-table" id="transactionsTable">
                    <thead><tr><th>æ—¥æœŸ</th><th>é¡¹ç›®</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="transactionsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ========== æç®€æµ®åŠ¨èœå• ========= -->
        <div class="fab-container">
            <button class="fab-transaction" id="fabMainBtn"><i class="fas fa-plus"></i></button>
            <div class="fab-menu" id="fabMenu">
                <button class="fab-menu-item" id="fabAddProject">
                    <i class="fas fa-folder-plus"></i>
                    <span>æ–°å»ºé¡¹ç›®</span>
                </button>
                <button class="fab-menu-item" id="fabAddTransaction">
                    <i class="fas fa-yen-sign"></i>
                    <span>æ–°å¢æ”¶æ”¯</span>
                </button>
            </div>
        </div>

        <!-- ========== æ¨¡æ€æ¡†ï¼šé¡¹ç›®ç®¡ç† ========= -->
        <div class="modal" id="projectModal">
            <div class="modal-content">
                <div class="modal-header"><h2 id="projectModalTitle">â• æ–°å»ºé¡¹ç›®</h2><button class="btn-close" id="closeProjectModal">&times;</button></div>
                <form id="projectForm">
                    <input type="hidden" id="projectId">
                    <div class="form-group"><label>ğŸ—ï¸ é¡¹ç›®åç§°</label><input type="text" id="projectName" class="form-control" placeholder="å¦‚ï¼šé˜³å…‰èŠ±å›­12-302" required></div>
                    <div class="form-group"><label>ğŸ’° åˆåŒæ€»é¢ / é¢„ç®— (å…ƒ)</label><input type="number" id="projectBudget" class="form-control" placeholder="150000" min="0" step="0.01" required></div>
                    <div class="milestone-section">
                        <div class="milestone-header">
                            <h4><i class="fas fa-file-signature"></i> æ”¶æ¬¾è®¡åˆ’</h4>
                            <button type="button" class="btn-add-milestone" id="addMilestoneBtn"><i class="fas fa-plus"></i> æ·»åŠ èŠ‚ç‚¹</button>
                        </div>
                        <div id="milestoneList" class="milestone-list"></div>
                        <div class="milestone-total"><span>åˆè®¡é‡‘é¢</span><span id="totalAmountDisplay">Â¥0.00</span></div>
                        <div id="milestoneWarning" style="color:#ffd93d; font-size:13px; margin-top:8px; display:none;"><i class="fas fa-exclamation-triangle"></i> æ”¶æ¬¾èŠ‚ç‚¹æ€»é¢ä¸åˆåŒæ€»é¢ä¸ç¬¦</div>
                        <input type="hidden" id="projectMilestones" value="[]">
                    </div>
                    <button type="submit" class="btn-submit" id="projectSubmitBtn">ä¿å­˜é¡¹ç›®</button>
                </form>
            </div>
        </div>

        <!-- ========== æ·»åŠ æ”¶æ¬¾èŠ‚ç‚¹æ¨¡æ€æ¡† ========= -->
        <div class="modal" id="milestoneModal">
            <div class="modal-content">
                <div class="modal-header"><h2>ğŸ“… æ·»åŠ æ”¶æ¬¾èŠ‚ç‚¹</h2><button class="btn-close" id="closeMilestoneModal">&times;</button></div>
                <form id="milestoneForm">
                    <div class="form-group"><label>ğŸ“… æ”¶æ¬¾æ—¥æœŸ</label><input type="date" id="milestoneDate" class="form-control" required></div>
                    <div class="form-group"><label>ğŸ’° æ”¶æ¬¾é‡‘é¢ (å…ƒ)</label><input type="number" id="milestoneAmount" class="form-control" placeholder="50000" min="0" step="0.01" required></div>
                    <div class="form-group"><label>ğŸ“ å¤‡æ³¨</label><input type="text" id="milestoneNote" class="form-control" placeholder="å¦‚ï¼šé¦–ä»˜æ¬¾ã€è¿›åº¦æ¬¾"></div>
                    <button type="submit" class="btn-submit">æ·»åŠ èŠ‚ç‚¹</button>
                </form>
            </div>
        </div>

        <!-- ========== æ¨¡æ€æ¡†ï¼šæ”¶æ”¯è®°å½• ========= -->
        <div class="modal" id="transactionModal">
            <div class="modal-content">
                <div class="modal-header"><h2 id="transactionModalTitle">ğŸ’° æ”¶æ”¯è®°å½•</h2><button class="btn-close" id="closeTransactionModal">&times;</button></div>
                <div class="voice-hero">
                    <button class="voice-btn" id="voiceInputBtn"><i class="fas fa-microphone"></i></button>
                    <div class="voice-info">
                        <h4><i class="fas fa-brain"></i> AIæ™ºèƒ½è¯­ä¹‰åŒ¹é…</h4>
                        <p>ç‚¹å‡»éº¦å…‹é£è¯­éŸ³è¾“å…¥ï¼Œæˆ–æ‰‹åŠ¨é€‰æ‹©ä¸‹æ–¹æ ‡ç­¾</p>
                    </div>
                </div>
                <div class="voice-status" id="voiceStatus">âœ¨ ç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³ï¼Œå†æ¬¡ç‚¹å‡»ç»“æŸå½•éŸ³</div>
                <form id="transactionForm">
                    <input type="hidden" id="transactionId">
                    <div class="form-group"><label>ğŸ“… æ—¥æœŸ</label><input type="date" id="transactionDate" class="form-control" required></div>
                    <div class="form-group"><label>ğŸ—ï¸ é¡¹ç›®</label><select id="transactionProject" class="form-control" required><option value="">è¯·é€‰æ‹©</option></select></div>
                    <div class="form-group">
                        <label>ğŸ·ï¸ è´¹ç”¨ç±»å‹ <span style="color:#00d4aa; font-size:12px;">ï¼ˆç‚¹å‡»æ ‡ç­¾æ‰‹åŠ¨é€‰æ‹©ï¼‰</span></label>
                        <div class="category-tags" id="categoryTags"></div>
                        <div class="custom-category-input">
                            <input type="text" id="customCategory" class="form-control" placeholder="è‡ªå®šä¹‰ç±»å‹">
                            <button type="button" class="btn-add-category" id="addCategoryBtn">æ·»åŠ </button>
                        </div>
                        <input type="hidden" id="transactionType" value="æ”¶å…¥">
                    </div>
                    <div class="form-group"><label>ğŸ’° é‡‘é¢ (å…ƒ)</label><input type="number" id="transactionAmount" class="form-control" placeholder="0.00" min="0" step="0.01" required></div>
                    <button type="submit" class="btn-submit" id="transactionSubmitBtn">âœ… ä¿å­˜è®°å½•</button>
                </form>
            </div>
        </div>

        <!-- ========== è¯­éŸ³ç¡®è®¤æ¨¡æ€æ¡† ========= -->
        <div class="modal" id="voiceConfirmModal">
            <div class="modal-content">
                <div class="modal-header"><h2>ğŸ¤ AIæ™ºèƒ½åŒ¹é…ç»“æœ</h2><button class="btn-close" id="closeVoiceConfirmModal">&times;</button></div>
                <div class="confirm-box" id="voiceConfirmContent"></div>
                <div class="confirm-buttons">
                    <button class="btn-modify" id="modifyVoiceResultBtn">ä¿®æ”¹</button>
                    <button class="btn-confirm" id="confirmVoiceResultBtn">ç¡®è®¤å¹¶æäº¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= æ³¨å†ŒChart.jsæ•°æ®æ ‡ç­¾æ’ä»¶ =================
        Chart.register(ChartDataLabels);
        
        // ================= é˜¿é‡Œäº‘ç™¾ç‚¼å¤§æ¨¡å‹ =================
        const BAILIAN_API_KEY = 'sk-cbfb73b5ae5b41608922e86705340311';
        const BAILIAN_BASE_URL = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
        
        // ========== è·å–å½“å¤©æ—¥æœŸ ==========
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ========== æ™ºèƒ½æ—¥æœŸè§£æ ==========
        function parseNaturalDate(dateText) {
            if (!dateText) return getTodayDate();
            const today = new Date();
            const currentYear = today.getFullYear();
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) return dateText;
            const chineseDateMatch = dateText.match(/(\d{2,4})?å¹´?(\d{1,2})æœˆ(\d{1,2})[å·æ—¥]?/);
            if (chineseDateMatch) {
                let year = chineseDateMatch[1] ? parseInt(chineseDateMatch[1]) : currentYear;
                if (year < 100) year += 2000;
                const month = parseInt(chineseDateMatch[2]);
                const day = parseInt(chineseDateMatch[3]);
                return `${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
            }
            if (dateText.includes('æ˜¨å¤©')) { const d = new Date(today); d.setDate(today.getDate()-1); return d.toISOString().split('T')[0]; }
            if (dateText.includes('ä»Šå¤©')) return getTodayDate();
            if (dateText.includes('æ˜å¤©')) { const d = new Date(today); d.setDate(today.getDate()+1); return d.toISOString().split('T')[0]; }
            return getTodayDate();
        }

        // ========== ä¸­æ–‡æ•°å­—è½¬é˜¿æ‹‰ä¼¯æ•°å­— ==========
        function chineseToNumber(chineseStr) {
            if (!chineseStr) return 0;
            const chineseNum = {'é›¶':0,'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10,'ç™¾':100,'åƒ':1000,'ä¸‡':10000,'äº¿':100000000,'ä¸¤':2,'ä¿©':2};
            const arabicMatch = chineseStr.match(/\d+/g);
            if (arabicMatch) return parseInt(arabicMatch[arabicMatch.length-1]);
            if (chineseStr.includes('åƒ')||chineseStr.includes('ç™¾')||chineseStr.includes('å')) {
                let result=0, current=0;
                for(let i=0;i<chineseStr.length;i++) {
                    const char = chineseStr[i];
                    if(chineseNum[char]!==undefined) {
                        if(chineseNum[char]>=10) {
                            if(current===0) current=1;
                            result += current * chineseNum[char];
                            current=0;
                        } else { current = chineseNum[char]; }
                    }
                }
                if(current>0) result+=current;
                return result||0;
            }
            return 0;
        }

        // ========== æ•°æ®æŒä¹…åŒ– ==========
        const Storage = {
            load: key => JSON.parse(localStorage.getItem(key) || '[]'),
            save: (key, data) => localStorage.setItem(key, JSON.stringify(data))
        };

        // ========== å…¨å±€çŠ¶æ€ ==========
        const AppState = {
            projects: Storage.load('projects') || [],
            transactions: Storage.load('transactions') || [],
            expenseTypes: Storage.load('expenseTypes') || ['ææ–™è´¹', 'äººå·¥è´¹', 'å…¶ä»–è´¹ç”¨'],

            addProject(id, name, budget, milestones) {
                if (id) {
                    const targetId = Number(id);
                    this.transactions = this.transactions.filter(t => Number(t.projectId) !== targetId);
                    this.projects = this.projects.filter(p => Number(p.id) !== targetId);
                    console.log(`ğŸ—‘ï¸ å·²åˆ é™¤é¡¹ç›®ID=${targetId} åŠå…¶æ‰€æœ‰æ”¶æ”¯è®°å½•`);
                }
                const newId = id ? Number(id) : Date.now();
                const proj = { 
                    id: newId, 
                    name, 
                    budget: parseFloat(budget),
                    milestones: milestones || [], 
                    createdAt: new Date().toISOString() 
                };
                this.projects.push(proj);
                Storage.save('projects', this.projects);
                Storage.save('transactions', this.transactions);
                console.log(`âœ… å·²æ·»åŠ æ–°é¡¹ç›® ID=${newId}`, proj);
                return proj;
            },
            deleteProject(id) {
                const targetId = Number(id);
                this.transactions = this.transactions.filter(t => Number(t.projectId) !== targetId);
                this.projects = this.projects.filter(p => Number(p.id) !== targetId);
                Storage.save('projects', this.projects); 
                Storage.save('transactions', this.transactions);
            },
            addTransaction(id, date, projectId, type, amount) {
                if (id) {
                    const targetId = Number(id);
                    this.transactions = this.transactions.filter(t => Number(t.id) !== targetId);
                    console.log(`ğŸ—‘ï¸ å·²åˆ é™¤äº¤æ˜“ ID=${targetId}`);
                }
                const newId = id ? Number(id) : Date.now();
                const trans = { 
                    id: newId, 
                    date, 
                    projectId: Number(projectId), 
                    type, 
                    amount: parseFloat(amount) 
                };
                this.transactions.push(trans);
                Storage.save('transactions', this.transactions);
                console.log(`âœ… å·²æ·»åŠ æ–°äº¤æ˜“ ID=${newId}`, trans);
                return trans;
            },
            deleteTransaction(id) {
                const targetId = Number(id);
                this.transactions = this.transactions.filter(t => Number(t.id) !== targetId);
                Storage.save('transactions', this.transactions);
            },
            addExpenseType(type) { 
                if(!this.expenseTypes.includes(type) && type.trim()){ 
                    this.expenseTypes.push(type); 
                    Storage.save('expenseTypes', this.expenseTypes); 
                } 
            },
            deleteExpenseType(type) { 
                if(this.expenseTypes.length > 1) { 
                    this.expenseTypes = this.expenseTypes.filter(t => t !== type); 
                    Storage.save('expenseTypes', this.expenseTypes); 
                } else alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªè´¹ç”¨ç±»å‹');
            },
            getProjectStats(pid) {
                const p = this.projects.find(p => Number(p.id) === Number(pid)); 
                if(!p) return null;
                const ts = this.transactions.filter(t => Number(t.projectId) === Number(pid));
                const income = ts.filter(t => t.type === 'æ”¶å…¥').reduce((s,t)=>s+t.amount,0);
                const expense = ts.filter(t => t.type !== 'æ”¶å…¥').reduce((s,t)=>s+t.amount,0);
                const contractTotal = p.budget || 0;
                const pendingIncome = Math.max(0, contractTotal - income);
                return { 
                    ...p, 
                    contractTotal,
                    pendingIncome,
                    income, 
                    expense, 
                    profit: income - expense, 
                    profitMargin: contractTotal > 0 ? ((income - expense) / contractTotal * 100) : 0 
                };
            },
            getAllStats() { return this.projects.map(p => this.getProjectStats(p.id)); },
            getOverallStats() {
                const all = this.getAllStats();
                return {
                    totalProjects: this.projects.length,
                    totalContract: all.reduce((s,st)=>s+(st.contractTotal||0),0),
                    totalIncome: all.reduce((s,st)=>s+st.income,0),
                    totalExpense: all.reduce((s,st)=>s+st.expense,0),
                    totalProfit: all.reduce((s,st)=>s+st.profit,0)
                };
            },
            getCostTypeAnalysis() {
                const map = {};
                this.transactions.filter(t => t.type !== 'æ”¶å…¥').forEach(t => { 
                    map[t.type] = (map[t.type]||0) + t.amount; 
                });
                return Object.keys(map).map(k=>({type:k, amount:map[k]})).sort((a,b)=>b.amount-a.amount);
            },
            getReceivableAnalysis() {
                const today = new Date();
                const sevenDaysLater = new Date(today);
                sevenDaysLater.setDate(today.getDate() + 7);
                let totalReceivable = 0, overdueAmount = 0, upcomingAmount = 0, overdueCount = 0, upcomingCount = 0, receivableItems = [];
                this.projects.forEach(project => {
                    const stats = this.getProjectStats(project.id);
                    if (!stats) return;
                    const pendingIncome = stats.pendingIncome;
                    if (pendingIncome <= 0) return;
                    totalReceivable += pendingIncome;
                    if (!project.milestones || project.milestones.length === 0) {
                        receivableItems.push({ 
                            projectId: project.id, 
                            projectName: project.name, 
                            dueDate: project.createdAt.split('T')[0], 
                            originalAmount: project.budget, 
                            receivedAmount: stats.income, 
                            pendingAmount: pendingIncome, 
                            note: 'åˆåŒæ€»é¢', 
                            status: new Date(project.createdAt) < today ? 'overdue' : 'normal' 
                        });
                        if (new Date(project.createdAt) < today) { overdueAmount += pendingIncome; overdueCount++; }
                        return;
                    }
                    const sortedMilestones = [...project.milestones].sort((a, b) => new Date(a.date) - new Date(b.date));
                    const projectIncomes = this.transactions
                        .filter(t => Number(t.projectId) === Number(project.id) && t.type === 'æ”¶å…¥')
                        .sort((a, b) => new Date(a.date) - new Date(b.date));
                    let incomeIndex = 0;
                    sortedMilestones.forEach((milestone, index) => {
                        const milestoneDate = new Date(milestone.date);
                        const milestoneAmount = milestone.amount;
                        let receivedBeforeMilestone = 0;
                        while (incomeIndex < projectIncomes.length) {
                            const income = projectIncomes[incomeIndex];
                            const incomeDate = new Date(income.date);
                            const nextMilestoneDate = index < sortedMilestones.length - 1 ? new Date(sortedMilestones[index + 1].date) : null;
                            if (!nextMilestoneDate || incomeDate < nextMilestoneDate) { 
                                receivedBeforeMilestone += income.amount; 
                                incomeIndex++; 
                            } else break;
                        }
                        const receivedForMilestone = Math.min(receivedBeforeMilestone, milestoneAmount);
                        const pendingForMilestone = milestoneAmount - receivedForMilestone;
                        if (pendingForMilestone > 0) {
                            let status = 'normal';
                            if (milestoneDate < today && receivedBeforeMilestone < milestoneAmount) { 
                                status = 'overdue'; 
                                overdueAmount += pendingForMilestone; 
                                overdueCount++; 
                            } else if (milestoneDate <= sevenDaysLater && milestoneDate >= today) { 
                                status = 'upcoming'; 
                                upcomingAmount += pendingForMilestone; 
                                upcomingCount++; 
                            }
                            receivableItems.push({
                                projectId: project.id,
                                projectName: project.name,
                                dueDate: milestone.date,
                                originalAmount: milestoneAmount,
                                receivedAmount: receivedForMilestone,
                                pendingAmount: pendingForMilestone,
                                note: milestone.note || '',
                                status
                            });
                        } else {
                            receivableItems.push({
                                projectId: project.id,
                                projectName: project.name,
                                dueDate: milestone.date,
                                originalAmount: milestoneAmount,
                                receivedAmount: milestoneAmount,
                                pendingAmount: 0,
                                note: milestone.note || '',
                                status: 'paid'
                            });
                        }
                    });
                });
                receivableItems.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                return { totalReceivable, overdueAmount, upcomingAmount, overdueCount, upcomingCount, items: receivableItems };
            }
        };

        // ========== DOM ç»‘å®š ==========
        const DOM = {
            totalProjects: document.getElementById('totalProjects'),
            totalContract: document.getElementById('totalContract'),
            totalIncome: document.getElementById('totalIncome'),
            totalExpense: document.getElementById('totalExpense'),
            totalGrossProfit: document.getElementById('totalGrossProfit'),
            totalProfit: document.getElementById('totalProfit'),
            totalReceivable: document.getElementById('totalReceivable'),
            totalReceivableCount: document.getElementById('totalReceivableCount'),
            overdueAmount: document.getElementById('overdueAmount'),
            overdueCount: document.getElementById('overdueCount'),
            upcomingAmount: document.getElementById('upcomingAmount'),
            upcomingCount: document.getElementById('upcomingCount'),
            receivableTableBody: document.getElementById('receivableTableBody'),
            summaryBody: document.getElementById('summaryTableBody'),
            projectsBody: document.getElementById('projectsTableBody'),
            transactionsBody: document.getElementById('transactionsTableBody'),
            tableTitle: document.getElementById('tableTitle'),
            summaryToggle: document.getElementById('summaryToggle'),
            projectsToggle: document.getElementById('projectsToggle'),
            transactionsToggle: document.getElementById('transactionsToggle'),
            exportBtn: document.getElementById('exportBtn'),
            projectModal: document.getElementById('projectModal'),
            transactionModal: document.getElementById('transactionModal'),
            milestoneModal: document.getElementById('milestoneModal'),
            voiceConfirmModal: document.getElementById('voiceConfirmModal'),
            closeProjectModal: document.getElementById('closeProjectModal'),
            closeTransactionModal: document.getElementById('closeTransactionModal'),
            closeMilestoneModal: document.getElementById('closeMilestoneModal'),
            closeVoiceConfirm: document.getElementById('closeVoiceConfirmModal'),
            projectForm: document.getElementById('projectForm'),
            projectId: document.getElementById('projectId'),
            projectName: document.getElementById('projectName'),
            projectBudget: document.getElementById('projectBudget'),
            milestoneList: document.getElementById('milestoneList'),
            totalAmountDisplay: document.getElementById('totalAmountDisplay'),
            milestoneWarning: document.getElementById('milestoneWarning'),
            projectModalTitle: document.getElementById('projectModalTitle'),
            projectSubmitBtn: document.getElementById('projectSubmitBtn'),
            addMilestoneBtn: document.getElementById('addMilestoneBtn'),
            milestoneForm: document.getElementById('milestoneForm'),
            milestoneDate: document.getElementById('milestoneDate'),
            milestoneAmount: document.getElementById('milestoneAmount'),
            milestoneNote: document.getElementById('milestoneNote'),
            transactionForm: document.getElementById('transactionForm'),
            transactionId: document.getElementById('transactionId'),
            transactionDate: document.getElementById('transactionDate'),
            transactionProject: document.getElementById('transactionProject'),
            transactionAmount: document.getElementById('transactionAmount'),
            transactionType: document.getElementById('transactionType'),
            transactionModalTitle: document.getElementById('transactionModalTitle'),
            transactionSubmitBtn: document.getElementById('transactionSubmitBtn'),
            categoryTags: document.getElementById('categoryTags'),
            customCategory: document.getElementById('customCategory'),
            addCategoryBtn: document.getElementById('addCategoryBtn'),
            voiceInputBtn: document.getElementById('voiceInputBtn'),
            voiceStatus: document.getElementById('voiceStatus'),
            voiceConfirmContent: document.getElementById('voiceConfirmContent'),
            modifyBtn: document.getElementById('modifyVoiceResultBtn'),
            confirmBtn: document.getElementById('confirmVoiceResultBtn'),
            profitChartBox: document.getElementById('profitChartBox'),
            // ç­›é€‰ç›¸å…³DOM
            projectSearchInput: document.getElementById('projectSearchInput'),
            projectSearchDropdown: document.getElementById('projectSearchDropdown'),
            selectedTagsArea: document.getElementById('selectedTagsArea'),
            timeFilterBtn: document.getElementById('timeFilterBtn'),
            timeDropdown: document.getElementById('timeDropdown'),
            timeFilterLabel: document.getElementById('timeFilterLabel')
        };

        let profitChart, costPieChart, currentMilestones = [];

        // ========== å·¥å…·å‡½æ•° ==========
        const formatMoney = (v) => 'Â¥' + v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        const formatNumber = (v) => v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

        // ========== æ”¶æ¬¾èŠ‚ç‚¹ç®¡ç† ==========
        function calculateMilestoneTotal() { 
            return currentMilestones.reduce((sum,m)=>sum+m.amount,0); 
        }
        function updateMilestoneTotalDisplay() {
            const total = calculateMilestoneTotal();
            DOM.totalAmountDisplay.textContent = formatMoney(total);
            const budget = parseFloat(DOM.projectBudget.value)||0;
            if(budget>0 && Math.abs(total-budget)>0.01) {
                DOM.milestoneWarning.style.display = 'block';
                DOM.milestoneWarning.innerHTML = `<i class="fas fa-exclamation-triangle"></i> æ”¶æ¬¾èŠ‚ç‚¹æ€»é¢ ${formatMoney(total)} ä¸åˆåŒæ€»é¢ ${formatMoney(budget)} ä¸ç¬¦`;
            } else DOM.milestoneWarning.style.display = 'none';
        }
        function renderMilestoneList() {
            DOM.milestoneList.innerHTML = '';
            if(currentMilestones.length===0) {
                DOM.milestoneList.innerHTML = '<div style="color:#777; text-align:center; padding:20px;"><i class="fas fa-file-signature"></i><br>æš‚æ— æ”¶æ¬¾èŠ‚ç‚¹ï¼Œç‚¹å‡»"æ·»åŠ èŠ‚ç‚¹"è®¾ç½®</div>';
                updateMilestoneTotalDisplay(); 
                return;
            }
            currentMilestones.sort((a,b)=>a.date.localeCompare(b.date)).forEach((ms,i)=>{
                const div = document.createElement('div'); 
                div.className='milestone-item';
                div.innerHTML = `<div class="milestone-info"><div class="milestone-date">ğŸ“… ${ms.date} ${ms.note?`Â· ${ms.note}`:''}</div><div class="milestone-amount">ğŸ’° ${formatMoney(ms.amount)}</div></div><div class="milestone-actions"><button class="btn-remove-milestone" data-index="${i}">åˆ é™¤</button></div>`;
                DOM.milestoneList.appendChild(div);
            });
            document.querySelectorAll('.btn-remove-milestone').forEach(btn=>{
                btn.addEventListener('click',(e)=>{
                    const idx = parseInt(e.target.getAttribute('data-index'));
                    currentMilestones.splice(idx,1);
                    renderMilestoneList(); 
                    updateMilestoneTotalDisplay();
                });
            });
            updateMilestoneTotalDisplay();
        }

        // ========== è´¹ç”¨ç±»å‹æ ‡ç­¾ ==========
        function renderCategoryTags() {
            DOM.categoryTags.innerHTML = '';
            const incomeTag = document.createElement('span'); 
            incomeTag.className='category-tag active'; 
            incomeTag.setAttribute('data-type','æ”¶å…¥'); 
            incomeTag.textContent='æ”¶å…¥';
            incomeTag.addEventListener('click',(e)=>{ e.preventDefault(); setActiveCategory('æ”¶å…¥'); });
            DOM.categoryTags.appendChild(incomeTag);
            AppState.expenseTypes.forEach(type=>{
                const tag = document.createElement('span'); 
                tag.className='category-tag'; 
                tag.setAttribute('data-type',type); 
                tag.innerHTML = `${type} <span class="remove-tag" data-type="${type}">&times;</span>`;
                tag.addEventListener('click',(e)=>{ if(e.target.classList.contains('remove-tag')) return; setActiveCategory(type); });
                const removeSpan = tag.querySelector('.remove-tag');
                removeSpan.addEventListener('click',(e)=>{
                    e.stopPropagation();
                    if(AppState.expenseTypes.length>1){ 
                        AppState.deleteExpenseType(type); 
                        renderCategoryTags(); 
                    } else alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªè´¹ç”¨ç±»å‹');
                });
                DOM.categoryTags.appendChild(tag);
            });
            setActiveCategory('æ”¶å…¥');
        }
        function setActiveCategory(type) {
            document.querySelectorAll('.category-tag').forEach(t=>t.classList.remove('active'));
            const activeTag = document.querySelector(`.category-tag[data-type="${type}"]`);
            if(activeTag) activeTag.classList.add('active');
            DOM.transactionType.value = type;
        }

        // ========== é¡¹ç›®ä¸‹æ‹‰æ¡† ==========
        function fillProjectSelect() {
            DOM.transactionProject.innerHTML = '<option value="">è¯·é€‰æ‹©é¡¹ç›®</option>' + 
                AppState.projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        }

        // ========== è¡¨æ ¼åˆ‡æ¢ ==========
        function bindToggles() {
            DOM.summaryToggle.onclick = ()=>{
                document.getElementById('summaryTable').style.display = 'table';
                document.getElementById('projectsTable').style.display = 'none';
                document.getElementById('transactionsTable').style.display = 'none';
                document.getElementById('projectsTableWrap').style.display = 'none';
                document.getElementById('transactionsTableWrap').style.display = 'none';
                DOM.summaryToggle.classList.add('active'); 
                DOM.projectsToggle.classList.remove('active'); 
                DOM.transactionsToggle.classList.remove('active');
                DOM.tableTitle.innerText = 'ğŸ“‹ ç»¼åˆæŠ¥è¡¨';
            };
            DOM.projectsToggle.onclick = ()=>{
                document.getElementById('summaryTable').style.display = 'none';
                document.getElementById('projectsTable').style.display = 'table';
                document.getElementById('transactionsTable').style.display = 'none';
                document.getElementById('projectsTableWrap').style.display = 'block';
                document.getElementById('transactionsTableWrap').style.display = 'none';
                DOM.projectsToggle.classList.add('active'); 
                DOM.summaryToggle.classList.remove('active'); 
                DOM.transactionsToggle.classList.remove('active');
                DOM.tableTitle.innerText = 'ğŸ“ é¡¹ç›®åˆ—è¡¨';
            };
            DOM.transactionsToggle.onclick = ()=>{
                document.getElementById('summaryTable').style.display = 'none';
                document.getElementById('projectsTable').style.display = 'none';
                document.getElementById('transactionsTable').style.display = 'table';
                document.getElementById('projectsTableWrap').style.display = 'none';
                document.getElementById('transactionsTableWrap').style.display = 'block';
                DOM.transactionsToggle.classList.add('active'); 
                DOM.summaryToggle.classList.remove('active'); 
                DOM.projectsToggle.classList.remove('active');
                DOM.tableTitle.innerText = 'ğŸ’¸ æ”¶æ”¯è®°å½•';
            };
        }

        // ========== æ›´æ–°åº”æ”¶è´¦æ¬¾ ==========
        function updateReceivableSection() {
            const analysis = AppState.getReceivableAnalysis();
            DOM.totalReceivable.textContent = formatMoney(analysis.totalReceivable);
            DOM.totalReceivableCount.textContent = `${analysis.items.filter(i=>i.pendingAmount>0).length}ç¬”å¾…æ”¶`;
            DOM.overdueAmount.textContent = formatMoney(analysis.overdueAmount);
            DOM.overdueCount.textContent = `${analysis.overdueCount}ç¬”é€¾æœŸ`;
            DOM.upcomingAmount.textContent = formatMoney(analysis.upcomingAmount);
            DOM.upcomingCount.textContent = `${analysis.upcomingCount}ç¬”7å¤©å†…åˆ°æœŸ`;
            if(analysis.items.length===0) {
                DOM.receivableTableBody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fas fa-file-invoice-dollar"></i><br>æš‚æ— åº”æ”¶è´¦æ¬¾</td></tr>';
                return;
            }
            DOM.receivableTableBody.innerHTML = analysis.items.map(item=>{
                let statusClass='', statusText='';
                if(item.status==='overdue'){ statusClass='status-overdue'; statusText='é€¾æœŸ'; }
                else if(item.status==='upcoming'){ statusClass='status-upcoming'; statusText='å³å°†åˆ°æœŸ'; }
                else if(item.status==='paid'){ statusClass='status-paid'; statusText='å·²ç»“æ¸…'; }
                else { statusClass='status-normal'; statusText='æ­£å¸¸'; }
                const amountDisplay = item.pendingAmount>0 ? formatMoney(item.pendingAmount) : 'å·²ç»“æ¸…';
                return `<tr><td>${item.projectName}</td><td>${item.dueDate}</td><td>${formatMoney(item.originalAmount)}</td><td>${formatMoney(item.receivedAmount)}</td><td class="${item.status==='overdue'?'overdue':(item.status==='upcoming'?'upcoming':'')}">${amountDisplay}</td><td><span class="status-badge ${statusClass}">${statusText}</span></td></tr>`;
            }).join('');
        }

        // ========== åˆ·æ–°æ‰€æœ‰UI ==========
        function refreshUI() {
            console.log('ğŸ”„ åˆ·æ–°UI...');
            if(profitChart) { profitChart.destroy(); profitChart=null; }
            if(costPieChart) { costPieChart.destroy(); costPieChart=null; }
            const ov = AppState.getOverallStats();
            DOM.totalProjects.textContent = ov.totalProjects;
            DOM.totalContract.textContent = formatMoney(ov.totalContract);
            DOM.totalIncome.textContent = formatMoney(ov.totalIncome);
            DOM.totalExpense.textContent = formatMoney(ov.totalExpense);
            const grossProfit = ov.totalContract - ov.totalExpense;
            DOM.totalGrossProfit.textContent = formatMoney(grossProfit);
            DOM.totalGrossProfit.className = 'value ' + (grossProfit>=0?'profit':'loss');
            DOM.totalProfit.textContent = formatMoney(ov.totalProfit);
            DOM.totalProfit.className = 'value ' + (ov.totalProfit>=0?'profit':'loss');
            const stats = AppState.getAllStats();
            if(stats.length) {
                DOM.summaryBody.innerHTML = stats.map(s=>`<tr><td>${s.name}</td><td>${formatMoney(s.contractTotal||0)}</td><td>${formatMoney(s.income)}</td><td class="${(s.pendingIncome||0)>0?'warning-cell':'profit-cell'}">${formatMoney(s.pendingIncome||0)}</td><td>${formatMoney(s.expense)}</td><td class="${s.profit>=0?'profit-cell':'loss-cell'}">${s.profit>=0?'':'-'}${formatMoney(Math.abs(s.profit))}</td><td class="${s.profit>=0?'profit-cell':'loss-cell'}">${s.profitMargin.toFixed(1)}%</td></tr>`).join('');
            } else { DOM.summaryBody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-chart-line"></i><br>æš‚æ— é¡¹ç›®</td></tr>'; }
            if(AppState.projects.length) {
                DOM.projectsBody.innerHTML = AppState.projects.map(p=>{ 
                    const s = AppState.getProjectStats(p.id); 
                    return `<tr><td>${p.name}</td><td>${formatMoney(p.budget||0)}</td><td>${p.milestones?p.milestones.length:0}ä¸ªèŠ‚ç‚¹</td><td>${formatMoney(s?.income||0)}</td><td class="${(s?.pendingIncome||0)>0?'warning-cell':'profit-cell'}">${formatMoney(s?.pendingIncome||0)}</td><td>${new Date(p.createdAt).toLocaleDateString()}</td><td><div class="action-buttons"><button class="btn-edit" data-id="${p.id}" onclick="window.editProject(${p.id})">ç¼–è¾‘</button><button class="btn-delete" data-id="${p.id}" onclick="window.deleteProject(${p.id})">åˆ é™¤</button></div></td></tr>`;
                }).join('');
            } else { DOM.projectsBody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-folder"></i><br>æš‚æ— é¡¹ç›®</td></tr>'; }
            if(AppState.transactions.length) {
                const sorted = [...AppState.transactions].sort((a,b)=>b.date.localeCompare(a.date));
                DOM.transactionsBody.innerHTML = sorted.map(t=>{ 
                    const proj = AppState.projects.find(p=>p.id===t.projectId); 
                    return `<tr><td>${t.date}</td><td>${proj?.name||'æœªçŸ¥'}</td><td>${t.type}</td><td class="${t.type==='æ”¶å…¥'?'profit-cell':'loss-cell'}">${t.type==='æ”¶å…¥'?'+':'-'}${formatMoney(t.amount)}</td><td><div class="action-buttons"><button class="btn-edit" data-id="${t.id}" onclick="window.editTransaction(${t.id})">ç¼–è¾‘</button><button class="btn-delete" data-id="${t.id}" onclick="window.deleteTransaction(${t.id})">åˆ é™¤</button></div></td></tr>`;
                }).join('');
            } else { DOM.transactionsBody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="fas fa-exchange-alt"></i><br>æš‚æ— æ”¶æ”¯</td></tr>'; }
            updateReceivableSection();
            setTimeout(()=>{ updateCharts(); addProfitCornerLabel(); }, 50);
            fillProjectSelect();
        }

        // ========== å›¾è¡¨æ›´æ–° ==========
        function updateCharts() {
            const ctxBar = document.getElementById('profitChart').getContext('2d');
            const ctxPie = document.getElementById('costPieChart').getContext('2d');
            
            let stats = AppState.getAllStats();
            if (typeof FilterState !== 'undefined' && FilterState.selectedProjectIds.size > 0) {
                const selectedIds = Array.from(FilterState.selectedProjectIds);
                stats = stats.filter(s => selectedIds.includes(s.id));
            }
            
            if (typeof FilterState !== 'undefined' && FilterState.timeRange && 
                FilterState.timeRange.type !== 'all' && 
                FilterState.timeRange.startDate && 
                FilterState.timeRange.endDate) {
                const start = new Date(FilterState.timeRange.startDate);
                const end = new Date(FilterState.timeRange.endDate);
                end.setHours(23, 59, 59, 999);
                
                stats = stats.map(stat => {
                    const timeFilteredTransactions = AppState.transactions.filter(t => 
                        Number(t.projectId) === stat.id &&
                        new Date(t.date) >= start &&
                        new Date(t.date) <= end
                    );
                    const income = timeFilteredTransactions.filter(t => t.type === 'æ”¶å…¥').reduce((s,t)=>s+t.amount,0);
                    const expense = timeFilteredTransactions.filter(t => t.type !== 'æ”¶å…¥').reduce((s,t)=>s+t.amount,0);
                    const profit = income - expense;
                    return {
                        ...stat,
                        income,
                        expense,
                        profit,
                        profitMargin: stat.contractTotal > 0 ? (profit / stat.contractTotal * 100) : 0,
                        pendingIncome: Math.max(0, stat.contractTotal - income)
                    };
                });
            }
            
            if(!stats.length) {
                profitChart = new Chart(ctxBar, { 
                    type:'bar', 
                    data:{ labels:['æ— æ•°æ®'], datasets:[{ label:'åˆåŒæ€»é¢', data:[0], backgroundColor:'#444' }] }, 
                    options:{ maintainAspectRatio:false, plugins:{ legend:{labels:{color:'#ccc'}}, datalabels:{display:false} } } 
                });
                costPieChart = new Chart(ctxPie, { 
                    type:'pie', 
                    data:{ labels:['æ— æ”¯å‡º'], datasets:[{ data:[1], backgroundColor:['#555'] }] }, 
                    options:{ maintainAspectRatio:true, aspectRatio:1.5, responsive:true, plugins:{ legend:{labels:{color:'#ccc'}}, datalabels:{display:false} } } 
                });
                return;
            }
            
            profitChart = new Chart(ctxBar, {
                type:'bar', 
                data: {
                    labels: stats.map(s=>s.name),
                    datasets: [
                        { label:'åˆåŒæ€»é¢', data: stats.map(s=>s.contractTotal), backgroundColor:'#6c757d' },
                        { label:'å·²æ”¶', data: stats.map(s=>s.income), backgroundColor:'#00d4aa' },
                        { label:'æ”¯å‡º', data: stats.map(s=>s.expense), backgroundColor:'#ff6b6b' },
                        { label:'åˆ©æ¶¦', data: stats.map(s=>s.profit), type:'line', borderColor:'#ffd93d', backgroundColor:'transparent', tension:0.2,
                          datalabels: { display: false },  
                          point: { radius: 3, backgroundColor:'#ffd93d' } }
                    ]
                }, 
                options: { 
                    maintainAspectRatio: false, 
                    layout: { padding: { top: 25, bottom: 20 } },
                    plugins: { 
                        legend: { labels: { color: '#ccc' } },
                        datalabels: {
                            display: true,
                            color: '#fff',
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            formatter: (value) => value ? 'Â¥' + value.toFixed(0) : ''
                        }
                    }, 
                    scales: { 
                        y: { ticks: { callback: v=>'Â¥'+v }, grid: { color:'#333' } }, 
                        x: { 
                            ticks: { 
                                color: '#ccc',
                                maxRotation: 0,
                                minRotation: 0,
                                autoSkip: true,
                                autoSkipPadding: 15,
                                maxTicksLimit: 8,
                                callback: function(val, index) {
                                    const fullName = this.getLabelForValue(val);
                                    if (!fullName) return '';
                                    const isMobile = window.innerWidth <= 768;
                                    const maxLength = isMobile ? 6 : 8;
                                    if (fullName.length <= maxLength) return fullName;
                                    const prefix = fullName.slice(0, 3);
                                    const suffix = fullName.slice(-3);
                                    return `${prefix}*${suffix}`;
                                }
                            },
                            grid: { display: false }
                        } 
                    } 
                },
                plugins: [ChartDataLabels]
            });
            
            // é¥¼å›¾æ•°æ®æºï¼šåº”ç”¨é¡¹ç›®å’Œæ—¶é—´ç­›é€‰
            let filteredTransactions = [...AppState.transactions];
            if (typeof FilterState !== 'undefined' && FilterState.selectedProjectIds.size > 0) {
                const selectedIds = Array.from(FilterState.selectedProjectIds);
                filteredTransactions = filteredTransactions.filter(t => selectedIds.includes(t.projectId));
            }
            if (typeof FilterState !== 'undefined' && FilterState.timeRange && 
                FilterState.timeRange.type !== 'all' && 
                FilterState.timeRange.startDate && 
                FilterState.timeRange.endDate) {
                const start = new Date(FilterState.timeRange.startDate);
                const end = new Date(FilterState.timeRange.endDate);
                end.setHours(23, 59, 59, 999);
                filteredTransactions = filteredTransactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate >= start && tDate <= end;
                });
            }
            
            const costMap = {};
            filteredTransactions.filter(t => t.type !== 'æ”¶å…¥').forEach(t => {
                costMap[t.type] = (costMap[t.type] || 0) + t.amount;
            });
            const costData = Object.keys(costMap).map(k => ({type: k, amount: costMap[k]})).sort((a,b) => b.amount - a.amount);
            
            if(costData.length) {
                const total = costData.reduce((s,i)=>s+i.amount,0);
                costPieChart = new Chart(ctxPie, {
                    type:'pie',
                    data: {
                        labels: costData.map(c=>c.type),
                        datasets: [{ 
                            data: costData.map(c=>c.amount), 
                            backgroundColor: ['#00d4aa','#ff6b6b','#ffd93d','#4dabf7','#9b5de5','#f15bb5'], 
                            borderWidth: 0, spacing: 0, offset: 0
                        }]
                    },
                    options: {
                        maintainAspectRatio: true,
                        aspectRatio: 0.8,
                        responsive: true,
                        cutout: '0%',
                        radius: '95%',
                        layout: { padding: { top: 1, bottom: 1, left: 1, right: 1 } },
                        plugins: {
                            tooltip: { 
                                callbacks: { 
                                    label: (ctx)=>`${ctx.label}: ${formatMoney(ctx.raw)} (${((ctx.raw/total)*100).toFixed(1)}%)` 
                                } 
                            },
                            legend: { 
                                labels: { 
                                    color:'#ccc', font: { size: 10 }, 
                                    boxWidth: 8, boxHeight: 8, padding: 6
                                }, 
                                position: 'bottom', align: 'center', maxHeight: 70, fullSize: false 
                            },
                            datalabels: {
                                display: true, 
                                color: '#fff', 
                                backgroundColor: 'rgba(0,0,0,0.7)', 
                                borderRadius: 4,
                                padding: { top: 3, bottom: 3, left: 6, right: 6 },
                                formatter: (v,ctx)=> { 
                                    const p = ((v/total)*100).toFixed(1); 
                                    return `${p}%`; 
                                },
                                font: { size: 10, weight: 'bold' },
                                align: 'center',
                                offset: 5
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } else {
                costPieChart = new Chart(ctxPie, { 
                    type:'pie', 
                    data:{ labels:['æš‚æ— æ”¯å‡º'], datasets:[{ data:[1], backgroundColor:['#555'] }] }, 
                    options:{ maintainAspectRatio: true, aspectRatio: 1.5, responsive: true, plugins:{ legend:{ labels:{ color:'#ccc' } }, datalabels:{ display:false } } } 
                });
            }
        }

        // ========== å³ä¸Šè§’æ¯›åˆ©æ¶¦æ€»é¢æ ‡æ³¨ ==========
        function addProfitCornerLabel() {
            const oldLabel = document.querySelector('.profit-corner-label');
            if(oldLabel) oldLabel.remove();
            let totalContract = 0, totalExpense = 0;
            if (typeof FilterState !== 'undefined') {
                let stats = AppState.getAllStats();
                const selectedIds = Array.from(FilterState.selectedProjectIds);
                if (selectedIds.length > 0) stats = stats.filter(s => selectedIds.includes(s.id));
                if (FilterState.timeRange && FilterState.timeRange.type !== 'all' && 
                    FilterState.timeRange.startDate && FilterState.timeRange.endDate) {
                    const start = new Date(FilterState.timeRange.startDate);
                    const end = new Date(FilterState.timeRange.endDate);
                    end.setHours(23, 59, 59, 999);
                    stats = stats.map(stat => {
                        const transactions = AppState.transactions.filter(t => 
                            Number(t.projectId) === stat.id && 
                            new Date(t.date) >= start && 
                            new Date(t.date) <= end
                        );
                        const expense = transactions.filter(t => t.type !== 'æ”¶å…¥').reduce((s,t)=>s+t.amount,0);
                        return { ...stat, expense };
                    });
                }
                totalContract = stats.reduce((s,st)=>s+(st.contractTotal||0),0);
                totalExpense = stats.reduce((s,st)=>s+st.expense,0);
            } else {
                const ov = AppState.getOverallStats();
                totalContract = ov.totalContract;
                totalExpense = ov.totalExpense;
            }
            const grossProfit = totalContract - totalExpense;
            const label = document.createElement('div');
            label.className = 'profit-corner-label';
            label.innerHTML = `æ¯›åˆ©æ¶¦ï¼š${formatMoney(grossProfit)}`;
            if(DOM.profitChartBox) DOM.profitChartBox.appendChild(label);
        }

        // ========== å…¨å±€å‡½æ•° ==========
        window.editProject = (id) => { 
            const p = AppState.projects.find(p=>p.id===id); if(!p) return;
            DOM.projectId.value = p.id; 
            DOM.projectName.value = p.name; 
            DOM.projectBudget.value = p.budget; 
            currentMilestones = p.milestones ? JSON.parse(JSON.stringify(p.milestones)) : [];
            renderMilestoneList();
            DOM.projectModalTitle.textContent = 'âœï¸ ç¼–è¾‘é¡¹ç›®'; 
            DOM.projectSubmitBtn.textContent = 'æ›´æ–°é¡¹ç›®';
            DOM.projectModal.classList.add('active');
        };
        window.deleteProject = (id) => { 
            if(confirm('åˆ é™¤é¡¹ç›®åŠæ‰€æœ‰æ”¶æ”¯ï¼Ÿ')){ 
                AppState.deleteProject(id); 
                refreshUI(); 
                if (typeof FilterState !== 'undefined') { 
                    FilterState.renderSelectedTags(); 
                    FilterState.applyFilter(); 
                } 
            } 
        };
        window.editTransaction = (id) => {
            const t = AppState.transactions.find(t=>t.id===id); if(!t) return;
            DOM.transactionId.value = t.id; 
            DOM.transactionDate.value = t.date; 
            DOM.transactionProject.value = t.projectId;
            DOM.transactionAmount.value = t.amount; 
            setActiveCategory(t.type);
            DOM.transactionModalTitle.textContent = 'âœï¸ ç¼–è¾‘æ”¶æ”¯'; 
            DOM.transactionSubmitBtn.textContent = 'æ›´æ–°è®°å½•';
            DOM.transactionModal.classList.add('active');
        };
        window.deleteTransaction = (id) => { 
            if(confirm('åˆ é™¤è¿™ç¬”è®°å½•ï¼Ÿ')){ 
                AppState.deleteTransaction(id); 
                refreshUI(); 
                if (typeof FilterState !== 'undefined') FilterState.applyFilter(); 
            } 
        };

        // ========== åˆå§‹åŒ–æ—¥æœŸ ==========
        function initDates() {
            const today = getTodayDate();
            if(DOM.transactionDate) DOM.transactionDate.value = today;
            if(DOM.milestoneDate) DOM.milestoneDate.value = today;
        }

        // ========== ç™¾ç‚¼AIè¯­éŸ³ ==========
        const BailianAI = {
            isListening: false, recognition: null,
            init() {
                if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                    DOM.voiceStatus.innerHTML = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³ï¼Œè¯·ç”¨Chrome/Edge';
                    DOM.voiceInputBtn.disabled = true; 
                    return false;
                }
                this.bindClickEvents();
                return true;
            },
            bindClickEvents() {
                const btn = DOM.voiceInputBtn;
                btn.onclick = null;
                btn.onclick = (e) => {
                    e.preventDefault(); 
                    e.stopPropagation();
                    if (!AppState.projects.length) { alert('è¯·å…ˆæ·»åŠ é¡¹ç›®'); return; }
                    if (this.isListening) { this.stopAndRecognize(); } else { this.startRecording(); }
                };
            },
            startRecording() {
                if (this.isListening) return;
                window.__currentTranscript = '';
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.lang = 'zh-CN'; 
                this.recognition.continuous = true; 
                this.recognition.interimResults = true; 
                this.recognition.maxAlternatives = 1;
                this.recognition.onstart = () => { 
                    this.isListening = true; 
                    DOM.voiceInputBtn.classList.add('listening'); 
                    DOM.voiceStatus.innerHTML = 'ğŸ¤ å½•éŸ³ä¸­â€¦ å†æ¬¡ç‚¹å‡»ç»“æŸ'; 
                    DOM.voiceStatus.style.color = '#ff6b6b'; 
                };
                this.recognition.onend = () => { 
                    this.isListening = false; 
                    DOM.voiceInputBtn.classList.remove('listening'); 
                    DOM.voiceStatus.style.color = '#ccc'; 
                    DOM.voiceStatus.innerHTML = 'âœ¨ ç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³'; 
                };
                this.recognition.onresult = (e) => {
                    let transcript = '';
                    for (let i = e.resultIndex; i < e.results.length; i++) 
                        transcript += e.results[i][0].transcript;
                    DOM.voiceStatus.innerHTML = `ğŸ¤ ${transcript}`;
                    window.__currentTranscript = transcript;
                };
                this.recognition.onerror = (e) => { 
                    DOM.voiceStatus.innerHTML = 'âŒ è¯­éŸ³è¯†åˆ«é”™è¯¯: ' + e.error; 
                    this.isListening = false; 
                    DOM.voiceInputBtn.classList.remove('listening'); 
                    DOM.voiceStatus.style.color = '#ccc'; 
                };
                try { this.recognition.start(); } 
                catch (e) { DOM.voiceStatus.innerHTML = 'âŒ å¯åŠ¨å½•éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•'; }
            },
            stopAndRecognize() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                    setTimeout(() => {
                        const finalText = window.__currentTranscript || '';
                        if (finalText.trim()) {
                            DOM.voiceStatus.innerHTML = `ğŸ“ è¯†åˆ«å®Œæˆ: "${finalText}" â†’ AIå¤„ç†ä¸­...`;
                            window.__voiceProcessing = true;
                            this.callBailianLLM(finalText).catch(() => {
                                this.enhancedLocalMatch(finalText);
                            }).finally(() => { window.__voiceProcessing = false; });
                        } else {
                            DOM.voiceStatus.innerHTML = 'âœ¨ æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•';
                            setTimeout(() => { DOM.voiceStatus.innerHTML = 'âœ¨ ç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³'; }, 2000);
                        }
                        window.__currentTranscript = '';
                    }, 100);
                }
            },
            async callBailianLLM(transcript) {
                if (!AppState.projects.length) { 
                    alert('è¯·å…ˆæ·»åŠ é¡¹ç›®'); 
                    DOM.voiceStatus.innerHTML = 'âš ï¸ å°šæœªåˆ›å»ºé¡¹ç›®'; 
                    return; 
                }
                const projectList = AppState.projects.map(p => p.name).join('ã€');
                const expenseTypeList = ['æ”¶å…¥', ...AppState.expenseTypes].join('ã€');
                const today = getTodayDate();
                const prompt = `ä½ æ˜¯ä¸€ä¸ªè£…ä¿®é¡¹ç›®è®°è´¦AIï¼Œä¸“é—¨å¤„ç†ä¸­æ–‡è¯­éŸ³è¯†åˆ«åçš„æ–‡å­—ã€‚\nç”¨æˆ·è¯´ï¼š"""${transcript}"""\né¡¹ç›®åç§°åˆ—è¡¨ï¼š[${projectList}]\nè´¹ç”¨ç±»å‹åˆ—è¡¨ï¼š[${expenseTypeList}]\nä»Šå¤©æ—¥æœŸï¼š${today}\nã€å¿…é¡»ä¸¥æ ¼éµå®ˆã€‘\n1. æ—¥æœŸè§£æï¼šæ”¯æŒå„ç§å£è¯­åŒ–æ—¥æœŸï¼Œå¦‚"25å¹´3æœˆ5å·"â†’2025-03-05ï¼Œè¾“å‡ºYYYY-MM-DD\n2. é¡¹ç›®åŒ¹é…ï¼šæ ¹æ®è¯­ä¹‰å’Œå‘éŸ³ç›¸ä¼¼åº¦åŒ¹é…é¡¹ç›®åç§°ï¼Œå¿…é¡»ä»é¡¹ç›®åˆ—è¡¨ä¸­é€‰æ‹©æœ€æ¥è¿‘çš„\n3. ç±»å‹åŒ¹é…ï¼šæ ¹æ®è¯­ä¹‰åŒ¹é…è´¹ç”¨ç±»å‹ï¼Œå¿…é¡»ä»è´¹ç”¨ç±»å‹åˆ—è¡¨ä¸­é€‰æ‹©\n4. é‡‘é¢æå–ï¼šå¿…é¡»æ­£ç¡®è½¬æ¢ä¸­æ–‡å¤§å†™/æ•°å­—ï¼Œå¦‚"ä¸¤ä¸‡"=20000ï¼Œ"ä¸‰åƒäºŒ"=3200\nåªè¾“å‡ºJSONï¼š{"date":"æ—¥æœŸ","project":"é¡¹ç›®å","type":"ç±»å‹","amount":æ•°å­—}`;
                try {
                    DOM.voiceStatus.innerHTML = 'ğŸ¤– ç™¾ç‚¼AIæ™ºèƒ½åŒ¹é…ä¸­...';
                    const response = await fetch(BAILIAN_BASE_URL, { 
                        method: 'POST', 
                        headers: { 
                            'Authorization': `Bearer ${BAILIAN_API_KEY}`, 
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify({ 
                            model: 'qwen-plus', 
                            messages: [{ 
                                role: 'system', 
                                content: 'ä½ æ˜¯ä¸“ä¸šçš„è®°è´¦AIï¼Œåªè¾“å‡ºçº¯å‡€JSON' 
                            }, { 
                                role: 'user', 
                                content: prompt 
                            }], 
                            temperature: 0.1, 
                            max_tokens: 200 
                        }) 
                    });
                    if (!response.ok) throw new Error(`APIé”™è¯¯ ${response.status}`);
                    const data = await response.json();
                    let aiText = data.choices?.[0]?.message?.content;
                    if (!aiText) throw new Error('æ— æ³•è§£æAIè¿”å›');
                    const jsonMatch = aiText.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error('AIæœªè¿”å›åˆæ³•JSON');
                    const result = JSON.parse(jsonMatch[0]);
                    let parsedDate = result.date || parseNaturalDate(transcript);
                    let matchedProject = null;
                    if (result.project) {
                        matchedProject = AppState.projects.find(p => p.name === result.project);
                        if (!matchedProject) 
                            matchedProject = AppState.projects.find(p => p.name.includes(result.project) || result.project.includes(p.name));
                    }
                    if (!matchedProject && AppState.projects.length) matchedProject = AppState.projects[0];
                    let amount = 0;
                    if (result.amount !== undefined) {
                        if (typeof result.amount === 'number') amount = result.amount;
                        else if (typeof result.amount === 'string') amount = chineseToNumber(result.amount);
                    }
                    if (!amount || amount <= 0) amount = this.extractAmount(transcript);
                    const voiceResult = { 
                        transcript, 
                        date: parsedDate || today,
                        project: matchedProject, 
                        type: result.type || this.extractType(transcript),
                        amount: amount || 0, 
                        confidence: 'high',
                        reason: `ç™¾ç‚¼AI: æ—¥æœŸ=${parsedDate}, é¡¹ç›®=${matchedProject?.name}, ç±»å‹=${result.type}, é‡‘é¢=${amount}`
                    };
                    this.showConfirm(voiceResult);
                    DOM.voiceStatus.innerHTML = `âœ… ç™¾ç‚¼AIåŒ¹é…æˆåŠŸ`;
                } catch (err) {
                    console.error('ç™¾ç‚¼APIè°ƒç”¨å¤±è´¥:', err);
                    DOM.voiceStatus.innerHTML = 'âš ï¸ ç™¾ç‚¼APIå¤±è´¥ï¼Œä½¿ç”¨å¢å¼ºæœ¬åœ°åŒ¹é…...';
                    throw err;
                }
            },
            enhancedLocalMatch(transcript) {
                const date = parseNaturalDate(transcript);
                let matchedProject = null;
                if (AppState.projects.length) {
                    matchedProject = AppState.projects.find(p => transcript.includes(p.name) || p.name.includes(transcript));
                    if (!matchedProject) { 
                        const keywords = transcript.replace(/[å·¥åœ°èŠ±å›­å°åŒºè£…ä¿®å·¥ç¨‹é¡¹ç›®éƒ¨]/g, '').trim(); 
                        matchedProject = AppState.projects.find(p => p.name.includes(keywords) || keywords.includes(p.name)); 
                    }
                    if (!matchedProject) matchedProject = AppState.projects[0];
                }
                let amount = this.extractAmount(transcript);
                let type = this.extractType(transcript);
                this.showConfirm({ 
                    transcript, 
                    date, 
                    project: matchedProject, 
                    type, 
                    amount: amount || 0, 
                    confidence: 'medium', 
                    reason: `å¢å¼ºæœ¬åœ°åŒ¹é…: é‡‘é¢=${amount}å…ƒ, ç±»å‹=${type}`
                });
            },
            extractAmount(text) {
                if (!text) return 0;
                const nums = text.match(/\d+(\.\d+)?/g);
                if (nums) {
                    let num = parseFloat(nums[nums.length-1]);
                    if (text.includes('ä¸‡') && num < 10000) num *= 10000;
                    if (text.includes('åƒ') && num < 1000) num *= 1000;
                    if (text.includes('ç™¾') && num < 100) num *= 100;
                    if (text.includes('å') && num < 10) num *= 10;
                    return num;
                }
                return chineseToNumber(text);
            },
            extractType(text) {
                text = text.toLowerCase();
                if (text.includes('æ”¶å…¥') || text.includes('æ”¶æ¬¾') || text.includes('è¿›è´¦') || 
                    text.includes('æ”¶åˆ°') || text.includes('æ”¶é’±') || text.includes('å›æ¬¾')) return 'æ”¶å…¥';
                const typeMap = { 
                    'ææ–™': 'ææ–™è´¹', 'äººå·¥': 'äººå·¥è´¹', 'å·¥èµ„': 'äººå·¥è´¹', 'å¸ˆå‚…': 'äººå·¥è´¹', 
                    'å·¥äºº': 'äººå·¥è´¹', 'è¿è´¹': 'è¿è¾“è´¹', 'ç‰©æµ': 'è¿è¾“è´¹', 'è®¾è®¡': 'è®¾è®¡è´¹', 
                    'å›¾çº¸': 'è®¾è®¡è´¹', 'ç›‘ç†': 'ç›‘ç†è´¹', 'ç®¡ç†': 'ç®¡ç†è´¹', 'ç‰©ä¸š': 'ç‰©ä¸šè´¹', 
                    'æŠ¼é‡‘': 'æŠ¼é‡‘', 'å®šé‡‘': 'å®šé‡‘', 'å°¾æ¬¾': 'å°¾æ¬¾', 'è®¾å¤‡': 'è®¾å¤‡è´¹', 
                    'å·¥å…·': 'å·¥å…·è´¹', 'åƒåœ¾': 'æ¸…è¿è´¹', 'æ‹†é™¤': 'æ‹†é™¤è´¹', 'æ°´ç”µ': 'æ°´ç”µè´¹', 
                    'å…¶ä»–': 'å…¶ä»–è´¹ç”¨' 
                };
                for (let [key, value] of Object.entries(typeMap)) { 
                    if (text.includes(key)) return value; 
                }
                return 'å…¶ä»–è´¹ç”¨';
            },
            showConfirm(result) {
                window.__voiceResult = result;
                let projectName = result.project ? result.project.name : 'âš ï¸ æœªåŒ¹é…é¡¹ç›®';
                let amountDisplay = result.amount ? 'Â¥' + formatNumber(result.amount) : 'æœªè¯†åˆ«';
                DOM.voiceConfirmContent.innerHTML = `
                    <div class="voice-result-item"><span>ğŸ—£ï¸ ä½ è¯´çš„</span><span style="color:#00d4aa;">"${result.transcript}"</span></div>
                    <div class="voice-match-hint"><i class="fas fa-robot" style="color:#00d4aa;"></i> ${result.reason || 'AIè¯­ä¹‰åŒ¹é…'}</div>
                    <div class="voice-result-item"><span>ğŸ“… è¯†åˆ«æ—¥æœŸ</span><span style="color:#00d4aa;">${result.date}</span></div>
                    <div class="voice-result-item"><span>ğŸ—ï¸ åŒ¹é…é¡¹ç›®</span><span style="color:#00d4aa;">${projectName}</span></div>
                    <div class="voice-result-item"><span>ğŸ·ï¸ åŒ¹é…ç±»å‹</span><span style="color:#00d4aa;">${result.type}</span></div>
                    <div class="voice-result-item"><span>ğŸ’° è¯†åˆ«é‡‘é¢</span><span style="color:${result.amount?'#00d4aa':'#ff6b6b'};">${amountDisplay}</span></div>
                `;
                DOM.voiceConfirmModal.classList.add('active');
            }
        };

        // ========== é¡¹ç›®+æ—¶é—´ ç­›é€‰æ ¸å¿ƒæ¨¡å— FilterState ==========
        const FilterState = {
            selectedProjectIds: new Set(),
            timeRange: { type: 'all', startDate: null, endDate: null, label: 'å…¨éƒ¨æ—¶é—´' },

            init() {
                this.loadFromStorage();
                this.loadTimeFromStorage();
                this.bindEvents();
                this.bindTimeEvents();
                this.renderDropdown();
                this.renderSelectedTags();
                this.updateTimeLabel();
                this.applyFilter();
            },

            // é¡¹ç›®ç­›é€‰
            loadFromStorage() {
                const saved = localStorage.getItem('selectedProjectIds');
                if (saved) { try { const ids = JSON.parse(saved); this.selectedProjectIds = new Set(ids); } catch (e) {} }
            },
            saveToStorage() {
                localStorage.setItem('selectedProjectIds', JSON.stringify(Array.from(this.selectedProjectIds)));
            },
            bindEvents() {
                const searchInput = DOM.projectSearchInput;
                const dropdown = DOM.projectSearchDropdown;
                if (!searchInput || !dropdown) return;
                searchInput.addEventListener('focus', () => { this.renderDropdown(searchInput.value.trim()); dropdown.classList.add('active'); });
                document.addEventListener('click', (e) => { 
                    if (!e.target.closest('.search-container') && !e.target.closest('.time-filter-container')) 
                        dropdown.classList.remove('active'); 
                });
                searchInput.addEventListener('input', () => { this.renderDropdown(searchInput.value.trim()); });
                searchInput.addEventListener('keypress', (e) => { 
                    if (e.key === 'Enter') { 
                        const kw = searchInput.value.trim(); 
                        if (kw) { 
                            const filtered = this.getFilteredProjects(kw); 
                            if (filtered.length > 0) { 
                                this.toggleProject(filtered[0].id); 
                                this.renderDropdown(''); 
                                searchInput.value = ''; 
                                dropdown.classList.remove('active'); 
                            } 
                        } 
                    } 
                });
            },
            getFilteredProjects(keyword = '') {
                let projects = [...AppState.projects];
                if (keyword) { const lower = keyword.toLowerCase(); projects = projects.filter(p => p.name.toLowerCase().includes(lower)); }
                return projects;
            },
            renderDropdown(keyword = '') {
                const dropdown = DOM.projectSearchDropdown;
                if (!dropdown) return;
                const projects = this.getFilteredProjects(keyword);
                if (projects.length === 0) { dropdown.innerHTML = '<div class="dropdown-empty">ğŸ” æœªæ‰¾åˆ°ç›¸å…³é¡¹ç›®</div>'; return; }
                let html = `<div class="dropdown-actions"><button class="dropdown-action-btn" id="selectAllBtn">å…¨é€‰</button><button class="dropdown-action-btn" id="clearAllBtn">æ¸…é™¤</button></div>`;
                projects.forEach(p => {
                    const isChecked = this.selectedProjectIds.has(p.id);
                    html += `<div class="dropdown-item" data-project-id="${p.id}">
                        <input type="checkbox" id="project_${p.id}" ${isChecked ? 'checked' : ''} data-project-id="${p.id}">
                        <label for="project_${p.id}"><span>${p.name}</span><span class="project-budget-badge">${formatMoney(p.budget || 0)}</span></label>
                    </div>`;
                });
                dropdown.innerHTML = html;
                dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => { 
                    cb.addEventListener('change', (e) => { 
                        e.stopPropagation(); 
                        const pid = parseInt(e.target.dataset.projectId); 
                        this.toggleProject(pid, e.target.checked); 
                    }); 
                });
                dropdown.querySelectorAll('.dropdown-item').forEach(item => { 
                    item.addEventListener('click', (e) => { 
                        if (e.target.type !== 'checkbox') { 
                            const cb = item.querySelector('input[type="checkbox"]'); 
                            cb.checked = !cb.checked; 
                            const pid = parseInt(item.dataset.projectId); 
                            this.toggleProject(pid, cb.checked); 
                        } 
                    }); 
                });
                const selectAllBtn = document.getElementById('selectAllBtn'); 
                if (selectAllBtn) { 
                    selectAllBtn.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        projects.forEach(p => this.selectedProjectIds.add(p.id)); 
                        this.saveToStorage(); 
                        this.renderDropdown(keyword); 
                        this.renderSelectedTags(); 
                        this.applyFilter(); 
                    }); 
                }
                const clearAllBtn = document.getElementById('clearAllBtn'); 
                if (clearAllBtn) { 
                    clearAllBtn.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        this.selectedProjectIds.clear(); 
                        this.saveToStorage(); 
                        this.renderDropdown(keyword); 
                        this.renderSelectedTags(); 
                        this.applyFilter(); 
                    }); 
                }
            },
            toggleProject(projectId, checked) {
                if (checked === undefined) {
                    if (this.selectedProjectIds.has(projectId)) this.selectedProjectIds.delete(projectId);
                    else this.selectedProjectIds.add(projectId);
                } else { 
                    if (checked) this.selectedProjectIds.add(projectId); 
                    else this.selectedProjectIds.delete(projectId); 
                }
                this.saveToStorage();
                this.renderSelectedTags();
                this.applyFilter();
            },
            renderSelectedTags() {
                const container = DOM.selectedTagsArea;
                if (!container) return;
                container.innerHTML = '';
                if (this.timeRange && this.timeRange.type !== 'all') {
                    const timeTag = document.createElement('span');
                    timeTag.id = 'timeRangeTag';
                    timeTag.className = 'time-tag';
                    timeTag.innerHTML = `<i class="fas fa-calendar-alt"></i><span>${this.timeRange.label}</span><span class="remove-tag" onclick="FilterState.clearTimeRange()">&times;</span>`;
                    container.appendChild(timeTag);
                }
                this.selectedProjectIds.forEach(id => {
                    const p = AppState.projects.find(p => p.id === id);
                    if (p) {
                        const tag = document.createElement('span');
                        tag.className = 'selected-tag';
                        tag.dataset.projectId = id;
                        tag.innerHTML = `<span>${p.name}</span><span class="remove-tag" onclick="FilterState.toggleProject(${id}, false)">&times;</span>`;
                        container.appendChild(tag);
                    }
                });
            },

            // æ—¶é—´ç­›é€‰
            bindTimeEvents() {
                const timeBtn = DOM.timeFilterBtn;
                const timeDropdown = DOM.timeDropdown;
                if (!timeBtn || !timeDropdown) return;
                timeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    timeDropdown.classList.toggle('active');
                    this.hideCustomDateRange();
                });
                timeDropdown.querySelectorAll('.time-dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const value = item.dataset.value;
                        timeDropdown.querySelectorAll('.time-dropdown-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        if (value === 'custom') {
                            this.showCustomDateRange();
                        } else {
                            this.setTimeRange(value);
                            timeDropdown.classList.remove('active');
                        }
                    });
                });
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.time-filter-container')) {
                        if (timeDropdown) timeDropdown.classList.remove('active');
                        this.hideCustomDateRange();
                    }
                });
            },
            setTimeRange(type, startDate = null, endDate = null) {
                const today = new Date();
                const end = new Date(today);
                end.setHours(23, 59, 59, 999);
                let start = new Date(today);
                start.setHours(0, 0, 0, 0);
                switch(type) {
                    case 'today': break;
                    case 'yesterday': start.setDate(today.getDate() - 1); end.setDate(today.getDate() - 1); break;
                    case 'week': start.setDate(today.getDate() - 6); break;
                    case 'month': start.setDate(today.getDate() - 29); break;
                    case 'quarter': start.setDate(today.getDate() - 89); break;
                    case 'all':
                    default:
                        this.timeRange = { type: 'all', startDate: null, endDate: null, label: 'å…¨éƒ¨æ—¶é—´' };
                        this.saveTimeToStorage();
                        this.updateTimeLabel();
                        this.renderSelectedTags();
                        this.applyFilter();
                        return;
                }
                if (type !== 'all' && type !== 'custom') {
                    this.timeRange = {
                        type,
                        startDate: start.toISOString().split('T')[0],
                        endDate: end.toISOString().split('T')[0],
                        label: this.getTimeLabel(type)
                    };
                }
                this.saveTimeToStorage();
                this.updateTimeLabel();
                this.renderSelectedTags();
                this.applyFilter();
            },
            getTimeLabel(type) {
                const map = { 'today': 'ä»Šæ—¥', 'yesterday': 'æ˜¨æ—¥', 'week': 'è¿‘7å¤©', 'month': 'è¿‘30å¤©', 'quarter': 'è¿‘90å¤©' };
                return map[type] || type;
            },
            updateTimeLabel() {
                if (DOM.timeFilterLabel) DOM.timeFilterLabel.textContent = this.timeRange.label;
            },
            clearTimeRange() {
                this.timeRange = { type: 'all', startDate: null, endDate: null, label: 'å…¨éƒ¨æ—¶é—´' };
                this.updateTimeLabel();
                this.renderSelectedTags();
                const dropdown = DOM.timeDropdown;
                if (dropdown) {
                    dropdown.querySelectorAll('.time-dropdown-item').forEach(i => i.classList.remove('active'));
                    const allItem = dropdown.querySelector('[data-value="all"]');
                    if (allItem) allItem.classList.add('active');
                }
                this.saveTimeToStorage();
                this.applyFilter();
            },
            showCustomDateRange() {
                this.hideCustomDateRange();
                const container = document.querySelector('.time-filter-container');
                if (!container) return;
                const div = document.createElement('div');
                div.className = 'custom-date-range active';
                div.id = 'customDateRange';
                div.innerHTML = `<div class="date-input"><input type="date" id="customStartDate" value="${this.timeRange.startDate || ''}"><span style="color:#888;">è‡³</span><input type="date" id="customEndDate" value="${this.timeRange.endDate || ''}"></div><button class="apply-btn" id="applyCustomDate">åº”ç”¨</button>`;
                container.appendChild(div);
                document.getElementById('applyCustomDate').addEventListener('click', () => {
                    const start = document.getElementById('customStartDate').value;
                    const end = document.getElementById('customEndDate').value;
                    if (start && end) {
                        this.timeRange = { type: 'custom', startDate: start, endDate: end, label: `${start.slice(5)}~${end.slice(5)}` };
                        this.updateTimeLabel();
                        this.renderSelectedTags();
                        this.saveTimeToStorage();
                        this.applyFilter();
                        this.hideCustomDateRange();
                        if (DOM.timeDropdown) DOM.timeDropdown.classList.remove('active');
                    }
                });
            },
            hideCustomDateRange() {
                const el = document.getElementById('customDateRange');
                if (el) el.remove();
            },
            saveTimeToStorage() {
                localStorage.setItem('timeFilter', JSON.stringify(this.timeRange));
            },
            loadTimeFromStorage() {
                const saved = localStorage.getItem('timeFilter');
                if (saved) {
                    try {
                        const tr = JSON.parse(saved);
                        if (tr && tr.type) {
                            this.timeRange = tr;
                            setTimeout(() => {
                                if (DOM.timeDropdown) {
                                    DOM.timeDropdown.querySelectorAll('.time-dropdown-item').forEach(i => i.classList.remove('active'));
                                    const activeItem = DOM.timeDropdown.querySelector(`[data-value="${tr.type}"]`);
                                    if (activeItem) activeItem.classList.add('active');
                                }
                                this.updateTimeLabel();
                            }, 50);
                        }
                    } catch (e) {}
                }
            },

            // æ ¸å¿ƒç­›é€‰åº”ç”¨
            applyFilter() {
                const selectedIds = Array.from(this.selectedProjectIds);
                let startDate = null, endDate = null;
                if (this.timeRange && this.timeRange.type !== 'all' && this.timeRange.startDate && this.timeRange.endDate) {
                    startDate = new Date(this.timeRange.startDate);
                    endDate = new Date(this.timeRange.endDate);
                    endDate.setHours(23, 59, 59, 999);
                }

                let allStats = AppState.getAllStats();
                if (selectedIds.length > 0) allStats = allStats.filter(s => selectedIds.includes(s.id));
                
                if (startDate && endDate) {
                    allStats = allStats.map(stat => {
                        const timeFilteredTransactions = AppState.transactions.filter(t => 
                            Number(t.projectId) === stat.id &&
                            new Date(t.date) >= startDate &&
                            new Date(t.date) <= endDate
                        );
                        const income = timeFilteredTransactions.filter(t => t.type === 'æ”¶å…¥').reduce((s,t)=>s+t.amount,0);
                        const expense = timeFilteredTransactions.filter(t => t.type !== 'æ”¶å…¥').reduce((s,t)=>s+t.amount,0);
                        const profit = income - expense;
                        return {
                            ...stat,
                            income,
                            expense,
                            profit,
                            profitMargin: stat.contractTotal > 0 ? (profit / stat.contractTotal * 100) : 0,
                            pendingIncome: Math.max(0, stat.contractTotal - income)
                        };
                    });
                }

                // ä»ªè¡¨ç›˜
                const totalProjects = allStats.length;
                const totalContract = allStats.reduce((s,st)=>s+(st.contractTotal||0),0);
                const totalIncome = allStats.reduce((s,st)=>s+st.income,0);
                const totalExpense = allStats.reduce((s,st)=>s+st.expense,0);
                const totalProfit = allStats.reduce((s,st)=>s+st.profit,0);
                const grossProfit = totalContract - totalExpense;
                if (DOM.totalProjects) DOM.totalProjects.textContent = totalProjects;
                if (DOM.totalContract) DOM.totalContract.textContent = formatMoney(totalContract);
                if (DOM.totalIncome) DOM.totalIncome.textContent = formatMoney(totalIncome);
                if (DOM.totalExpense) DOM.totalExpense.textContent = formatMoney(totalExpense);
                if (DOM.totalGrossProfit) { 
                    DOM.totalGrossProfit.textContent = formatMoney(grossProfit); 
                    DOM.totalGrossProfit.className = 'value ' + (grossProfit>=0?'profit':'loss'); 
                }
                if (DOM.totalProfit) { 
                    DOM.totalProfit.textContent = formatMoney(totalProfit); 
                    DOM.totalProfit.className = 'value ' + (totalProfit>=0?'profit':'loss'); 
                }

                // ç»¼åˆæŠ¥è¡¨
                if (DOM.summaryBody) {
                    if(allStats.length) {
                        DOM.summaryBody.innerHTML = allStats.map(s=>`<tr><td>${s.name}</td><td>${formatMoney(s.contractTotal||0)}</td><td>${formatMoney(s.income)}</td><td class="${(s.pendingIncome||0)>0?'warning-cell':'profit-cell'}">${formatMoney(s.pendingIncome||0)}</td><td>${formatMoney(s.expense)}</td><td class="${s.profit>=0?'profit-cell':'loss-cell'}">${s.profit>=0?'':'-'}${formatMoney(Math.abs(s.profit))}</td><td class="${s.profit>=0?'profit-cell':'loss-cell'}">${s.profitMargin.toFixed(1)}%</td></tr>`).join('');
                    } else { 
                        DOM.summaryBody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-chart-line"></i><br>æš‚æ— é¡¹ç›®</td></tr>'; 
                    }
                }

                // é¡¹ç›®åˆ—è¡¨
                let projects = AppState.projects;
                if (selectedIds.length > 0) projects = projects.filter(p => selectedIds.includes(p.id));
                if (DOM.projectsBody) {
                    if(projects.length) {
                        DOM.projectsBody.innerHTML = projects.map(p=>{ 
                            const s = allStats.find(stat => stat.id === p.id) || AppState.getProjectStats(p.id);
                            return `<tr><td>${p.name}</td><td>${formatMoney(p.budget||0)}</td><td>${p.milestones?p.milestones.length:0}ä¸ªèŠ‚ç‚¹</td><td>${formatMoney(s?.income||0)}</td><td class="${(s?.pendingIncome||0)>0?'warning-cell':'profit-cell'}">${formatMoney(s?.pendingIncome||0)}</td><td>${new Date(p.createdAt).toLocaleDateString()}</td><td><div class="action-buttons"><button class="btn-edit" data-id="${p.id}" onclick="window.editProject(${p.id})">ç¼–è¾‘</button><button class="btn-delete" data-id="${p.id}" onclick="window.deleteProject(${p.id})">åˆ é™¤</button></div></td></tr>`;
                        }).join('');
                    } else { 
                        DOM.projectsBody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-folder"></i><br>æš‚æ— é¡¹ç›®</td></tr>'; 
                    }
                }

                // æ”¶æ”¯è®°å½•
                let transactions = AppState.transactions;
                if (selectedIds.length > 0) transactions = transactions.filter(t => selectedIds.includes(t.projectId));
                if (startDate && endDate) {
                    transactions = transactions.filter(t => new Date(t.date) >= startDate && new Date(t.date) <= endDate);
                }
                if (DOM.transactionsBody) {
                    if(transactions.length) {
                        const sorted = [...transactions].sort((a,b)=>b.date.localeCompare(a.date));
                        DOM.transactionsBody.innerHTML = sorted.map(t=>{ 
                            const proj = AppState.projects.find(p=>p.id===t.projectId); 
                            return `<tr><td>${t.date}</td><td>${proj?.name||'æœªçŸ¥'}</td><td>${t.type}</td><td class="${t.type==='æ”¶å…¥'?'profit-cell':'loss-cell'}">${t.type==='æ”¶å…¥'?'+':'-'}${formatMoney(t.amount)}</td><td><div class="action-buttons"><button class="btn-edit" data-id="${t.id}" onclick="window.editTransaction(${t.id})">ç¼–è¾‘</button><button class="btn-delete" data-id="${t.id}" onclick="window.deleteTransaction(${t.id})">åˆ é™¤</button></div></td></tr>`;
                        }).join('');
                    } else { 
                        DOM.transactionsBody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="fas fa-exchange-alt"></i><br>æš‚æ— æ”¶æ”¯</td></tr>'; 
                    }
                }

                // åº”æ”¶è´¦æ¬¾
                const analysis = AppState.getReceivableAnalysis();
                let filteredItems = analysis.items;
                if (selectedIds.length > 0) filteredItems = filteredItems.filter(item => selectedIds.includes(item.projectId));
                const totalReceivable = filteredItems.reduce((s,i)=>s+i.pendingAmount,0);
                const overdueAmount = filteredItems.filter(i=>i.status==='overdue').reduce((s,i)=>s+i.pendingAmount,0);
                const upcomingAmount = filteredItems.filter(i=>i.status==='upcoming').reduce((s,i)=>s+i.pendingAmount,0);
                const overdueCount = filteredItems.filter(i=>i.status==='overdue').length;
                const upcomingCount = filteredItems.filter(i=>i.status==='upcoming').length;
                if (DOM.totalReceivable) DOM.totalReceivable.textContent = formatMoney(totalReceivable);
                if (DOM.totalReceivableCount) DOM.totalReceivableCount.textContent = `${filteredItems.filter(i=>i.pendingAmount>0).length}ç¬”å¾…æ”¶`;
                if (DOM.overdueAmount) DOM.overdueAmount.textContent = formatMoney(overdueAmount);
                if (DOM.overdueCount) DOM.overdueCount.textContent = `${overdueCount}ç¬”é€¾æœŸ`;
                if (DOM.upcomingAmount) DOM.upcomingAmount.textContent = formatMoney(upcomingAmount);
                if (DOM.upcomingCount) DOM.upcomingCount.textContent = `${upcomingCount}ç¬”7å¤©å†…åˆ°æœŸ`;
                if (DOM.receivableTableBody) {
                    if(filteredItems.length===0) { 
                        DOM.receivableTableBody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fas fa-file-invoice-dollar"></i><br>æš‚æ— åº”æ”¶è´¦æ¬¾</td></tr>'; 
                    } else {
                        DOM.receivableTableBody.innerHTML = filteredItems.map(item=>{
                            let statusClass='', statusText='';
                            if(item.status==='overdue'){ statusClass='status-overdue'; statusText='é€¾æœŸ'; }
                            else if(item.status==='upcoming'){ statusClass='status-upcoming'; statusText='å³å°†åˆ°æœŸ'; }
                            else if(item.status==='paid'){ statusClass='status-paid'; statusText='å·²ç»“æ¸…'; }
                            else { statusClass='status-normal'; statusText='æ­£å¸¸'; }
                            const amountDisplay = item.pendingAmount>0 ? formatMoney(item.pendingAmount) : 'å·²ç»“æ¸…';
                            return `<tr><td>${item.projectName}</td><td>${item.dueDate}</td><td>${formatMoney(item.originalAmount)}</td><td>${formatMoney(item.receivedAmount)}</td><td class="${item.status==='overdue'?'overdue':(item.status==='upcoming'?'upcoming':'')}">${amountDisplay}</td><td><span class="status-badge ${statusClass}">${statusText}</span></td></tr>`;
                        }).join('');
                    }
                }

                // å›¾è¡¨
                if(profitChart) { profitChart.destroy(); profitChart=null; }
                if(costPieChart) { costPieChart.destroy(); costPieChart=null; }
                setTimeout(() => { updateCharts(); addProfitCornerLabel(); }, 50);
            }
        };
        window.FilterState = FilterState;

        // ========== åˆå§‹åŒ–App ==========
        function initApp() {
            initDates();
            BailianAI.init();
            renderCategoryTags();
            DOM.projectBudget.addEventListener('input', updateMilestoneTotalDisplay);

            DOM.projectForm.onsubmit = (e) => {
                e.preventDefault();
                const total = calculateMilestoneTotal();
                const budget = parseFloat(DOM.projectBudget.value)||0;
                if(budget>0 && Math.abs(total-budget)>0.01 && !confirm(`æ”¶æ¬¾èŠ‚ç‚¹æ€»é¢ ${formatMoney(total)} ä¸åˆåŒæ€»é¢ ${formatMoney(budget)} ä¸ç¬¦ï¼Œæ˜¯å¦ç»§ç»­ä¿å­˜ï¼Ÿ`)) return;
                AppState.addProject(DOM.projectId.value||null, DOM.projectName.value, DOM.projectBudget.value, currentMilestones);
                DOM.projectModal.classList.remove('active'); 
                DOM.projectForm.reset(); 
                DOM.projectId.value=''; 
                currentMilestones=[]; 
                renderMilestoneList();
                DOM.projectModalTitle.textContent = 'â• æ–°å»ºé¡¹ç›®'; 
                DOM.projectSubmitBtn.textContent = 'ä¿å­˜é¡¹ç›®';
                refreshUI();
                if (typeof FilterState !== 'undefined') { 
                    FilterState.renderDropdown(); 
                    FilterState.renderSelectedTags(); 
                    FilterState.applyFilter(); 
                }
            };

            DOM.transactionForm.onsubmit = (e) => {
                e.preventDefault();
                AppState.addTransaction(DOM.transactionId.value||null, DOM.transactionDate.value, DOM.transactionProject.value, DOM.transactionType.value, DOM.transactionAmount.value);
                DOM.transactionModal.classList.remove('active'); 
                DOM.transactionForm.reset(); 
                DOM.transactionId.value=''; 
                initDates(); 
                setActiveCategory('æ”¶å…¥');
                DOM.transactionModalTitle.textContent = 'ğŸ’° æ”¶æ”¯è®°å½•'; 
                DOM.transactionSubmitBtn.textContent = 'ä¿å­˜è®°å½•';
                refreshUI();
                if (typeof FilterState !== 'undefined') FilterState.applyFilter();
            };

            DOM.closeProjectModal.onclick = ()=>{ 
                DOM.projectModal.classList.remove('active'); 
                DOM.projectForm.reset(); 
                DOM.projectId.value=''; 
                currentMilestones=[]; 
                renderMilestoneList(); 
            };
            DOM.closeTransactionModal.onclick = ()=>{ 
                DOM.transactionModal.classList.remove('active'); 
                DOM.transactionForm.reset(); 
                initDates(); 
                setActiveCategory('æ”¶å…¥'); 
            };
            DOM.closeMilestoneModal.onclick = ()=>{ 
                DOM.milestoneModal.classList.remove('active'); 
                DOM.milestoneForm.reset(); 
                initDates(); 
            };
            DOM.closeVoiceConfirm.onclick = ()=> DOM.voiceConfirmModal.classList.remove('active');

// ========== è¯­éŸ³ç¡®è®¤æŒ‰é’®äº‹ä»¶ ==========
DOM.modifyBtn.onclick = ()=>{
    DOM.voiceConfirmModal.classList.remove('active');
    if(window.__voiceResult) {
        fillProjectSelect();
        DOM.transactionDate.value = window.__voiceResult.date;
        if(window.__voiceResult.project) DOM.transactionProject.value = window.__voiceResult.project.id;
        DOM.transactionAmount.value = window.__voiceResult.amount||'';
        setActiveCategory(window.__voiceResult.type||'å…¶ä»–è´¹ç”¨');
    }
};

DOM.confirmBtn.onclick = ()=>{
    if(!window.__voiceResult||!window.__voiceResult.project){ alert('é¡¹ç›®æ— æ•ˆï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©'); return; }
    if(!window.__voiceResult.amount||window.__voiceResult.amount<=0){ alert('é‡‘é¢æ— æ•ˆ'); return; }
    AppState.addTransaction(null, window.__voiceResult.date, window.__voiceResult.project.id, window.__voiceResult.type, window.__voiceResult.amount);
    DOM.voiceConfirmModal.classList.remove('active');
    DOM.transactionModal.classList.remove('active');
    refreshUI();
    if (typeof FilterState !== 'undefined') FilterState.applyFilter();
    DOM.voiceStatus.innerHTML = 'âœ… è¯­éŸ³è®°è´¦æˆåŠŸï¼';
    setTimeout(()=>{ DOM.voiceStatus.innerHTML = 'âœ¨ ç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³'; },3000);
};

console.log('âœ… è¯­éŸ³ç¡®è®¤æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');

            window.onclick = (e)=>{
                if(e.target===DOM.projectModal) { 
                    DOM.projectModal.classList.remove('active'); 
                    DOM.projectForm.reset(); 
                    DOM.projectId.value=''; 
                    currentMilestones=[]; 
                    renderMilestoneList(); 
                }
                if(e.target===DOM.transactionModal) { 
                    DOM.transactionModal.classList.remove('active'); 
                    DOM.transactionForm.reset(); 
                    initDates(); 
                    setActiveCategory('æ”¶å…¥'); 
                }
                if(e.target===DOM.milestoneModal) { 
                    DOM.milestoneModal.classList.remove('active'); 
                    DOM.milestoneForm.reset(); 
                    initDates(); 
                }
                if(e.target===DOM.voiceConfirmModal) DOM.voiceConfirmModal.classList.remove('active');
            };
            
            // âœ… æ·»åŠ èŠ‚ç‚¹æŒ‰é’®äº‹ä»¶ï¼ˆé˜²æŠ– + é˜»æ­¢å†’æ³¡ï¼Œç¡®ä¿æ— é™æ¬¡æ·»åŠ ï¼‰
            DOM.addMilestoneBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                DOM.milestoneModal.classList.add('active');
            };

            // ========== æç®€æµ®åŠ¨æŒ‰é’®æ§åˆ¶ ==========
            const fabMainBtn = document.getElementById('fabMainBtn');
            const fabMenu = document.getElementById('fabMenu');
            const fabAddProject = document.getElementById('fabAddProject');
            const fabAddTransaction = document.getElementById('fabAddTransaction');

            if (fabMainBtn && fabMenu) {
                fabMainBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    fabMenu.classList.toggle('active');
                });

                if (fabAddProject) {
                    fabAddProject.addEventListener('click', () => {
                        fabMenu.classList.remove('active');
                        DOM.projectModalTitle.textContent = 'â• æ–°å»ºé¡¹ç›®';
                        DOM.projectSubmitBtn.textContent = 'ä¿å­˜é¡¹ç›®';
                        DOM.projectId.value = '';
                        DOM.projectName.value = '';
                        DOM.projectBudget.value = '';
                        currentMilestones = [];
                        renderMilestoneList();
                        DOM.projectModal.classList.add('active');
                    });
                }

                if (fabAddTransaction) {
                    fabAddTransaction.addEventListener('click', () => {
                        fabMenu.classList.remove('active');
                        fillProjectSelect();
                        DOM.transactionModalTitle.textContent = 'ğŸ’° æ”¶æ”¯è®°å½•';
                        DOM.transactionSubmitBtn.textContent = 'ä¿å­˜è®°å½•';
                        DOM.transactionId.value = '';
                        initDates();
                        setActiveCategory('æ”¶å…¥');
                        DOM.transactionModal.classList.add('active');
                    });
                }

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.fab-container')) {
                        fabMenu.classList.remove('active');
                    }
                });
            }

            // âœ… æ”¶æ¬¾èŠ‚ç‚¹è¡¨å•æäº¤ï¼ˆæ— é™æ·»åŠ ï¼Œä¸è·³è½¬é¡µé¢ï¼‰
            DOM.milestoneForm.onsubmit = (e) => {
                e.preventDefault();
                try {
                    const milestone = { 
                        date: DOM.milestoneDate.value, 
                        amount: parseFloat(DOM.milestoneAmount.value), 
                        note: DOM.milestoneNote.value.trim() || '' 
                    };
                    currentMilestones.push(milestone);
                    renderMilestoneList();
                    DOM.milestoneModal.classList.remove('active'); 
                    DOM.milestoneForm.reset(); 
                    initDates();
                } catch (err) {
                    console.error('æ·»åŠ èŠ‚ç‚¹å¤±è´¥:', err);
                    alert('èŠ‚ç‚¹æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            };

            DOM.addCategoryBtn.onclick = ()=>{ 
                const val = DOM.customCategory.value.trim(); 
                if(val){ 
                    AppState.addExpenseType(val); 
                    renderCategoryTags(); 
                    DOM.customCategory.value=''; 
                    setActiveCategory(val); 
                } 
            };

            DOM.exportBtn.onclick = ()=>{
                let data=[], sheetName='', headers=[];
                if(document.getElementById('summaryTable').style.display!=='none') {
                    sheetName='ç»¼åˆæŠ¥è¡¨'; 
                    headers=['é¡¹ç›®','åˆåŒæ€»é¢','å·²æ”¶','å¾…æ”¶','æ”¯å‡º','åˆ©æ¶¦','æ¯›åˆ©ç‡'];
                    let stats = AppState.getAllStats();
                    if (typeof FilterState !== 'undefined') {
                        const selectedIds = Array.from(FilterState.selectedProjectIds);
                        if (selectedIds.length > 0) stats = stats.filter(s => selectedIds.includes(s.id));
                        if (FilterState.timeRange && FilterState.timeRange.type !== 'all' && FilterState.timeRange.startDate && FilterState.timeRange.endDate) {
                            const start = new Date(FilterState.timeRange.startDate);
                            const end = new Date(FilterState.timeRange.endDate);
                            end.setHours(23,59,59,999);
                            stats = stats.map(stat => {
                                const transactions = AppState.transactions.filter(t => Number(t.projectId) === stat.id && new Date(t.date) >= start && new Date(t.date) <= end);
                                const income = transactions.filter(t => t.type === 'æ”¶å…¥').reduce((s,t)=>s+t.amount,0);
                                const expense = transactions.filter(t => t.type !== 'æ”¶å…¥').reduce((s,t)=>s+t.amount,0);
                                return { ...stat, income, expense, profit: income - expense, profitMargin: stat.contractTotal > 0 ? ((income - expense) / stat.contractTotal * 100) : 0, pendingIncome: Math.max(0, stat.contractTotal - income) };
                            });
                        }
                    }
                    data = stats.map(s=>[s.name, s.contractTotal||0, s.income, s.pendingIncome||0, s.expense, s.profit, s.profitMargin.toFixed(1)]);
                } else if(document.getElementById('projectsTable').style.display!=='none') {
                    sheetName='é¡¹ç›®åˆ—è¡¨'; 
                    headers=['é¡¹ç›®åç§°','åˆåŒæ€»é¢','æ”¶æ¬¾èŠ‚ç‚¹','å·²æ”¶','å¾…æ”¶','åˆ›å»ºæ—¶é—´'];
                    let projects = AppState.projects;
                    if (typeof FilterState !== 'undefined' && FilterState.selectedProjectIds.size > 0) {
                        const selectedIds = Array.from(FilterState.selectedProjectIds);
                        projects = projects.filter(p => selectedIds.includes(p.id));
                    }
                    data = projects.map(p=>{ 
                        let s = AppState.getProjectStats(p.id);
                        if (typeof FilterState !== 'undefined' && FilterState.timeRange && FilterState.timeRange.type !== 'all' && FilterState.timeRange.startDate && FilterState.timeRange.endDate) {
                            const start = new Date(FilterState.timeRange.startDate);
                            const end = new Date(FilterState.timeRange.endDate);
                            end.setHours(23,59,59,999);
                            const transactions = AppState.transactions.filter(t => Number(t.projectId) === p.id && new Date(t.date) >= start && new Date(t.date) <= end);
                            const income = transactions.filter(t => t.type === 'æ”¶å…¥').reduce((s,t)=>s+t.amount,0);
                            s = { ...s, income, pendingIncome: Math.max(0, (p.budget||0) - income) };
                        }
                        return [p.name, p.budget||0, p.milestones?.length||0, s?.income||0, s?.pendingIncome||0, new Date(p.createdAt).toLocaleDateString()];
                    });
                } else {
                    sheetName='æ”¶æ”¯è®°å½•'; 
                    headers=['æ—¥æœŸ','é¡¹ç›®','ç±»å‹','é‡‘é¢'];
                    let transactions = AppState.transactions;
                    if (typeof FilterState !== 'undefined') {
                        if (FilterState.selectedProjectIds.size > 0) transactions = transactions.filter(t => FilterState.selectedProjectIds.has(t.projectId));
                        if (FilterState.timeRange && FilterState.timeRange.type !== 'all' && FilterState.timeRange.startDate && FilterState.timeRange.endDate) {
                            const start = new Date(FilterState.timeRange.startDate);
                            const end = new Date(FilterState.timeRange.endDate);
                            end.setHours(23,59,59,999);
                            transactions = transactions.filter(t => new Date(t.date) >= start && new Date(t.date) <= end);
                        }
                    }
                    const sorted = [...transactions].sort((a,b)=>b.date.localeCompare(a.date));
                    data = sorted.map(t=>{ 
                        const p=AppState.projects.find(p=>p.id===t.projectId); 
                        return [t.date, p?.name||'æœªçŸ¥', t.type, t.type==='æ”¶å…¥'?t.amount:-t.amount]; 
                    });
                }
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                ws['!cols'] = headers.map(()=>({wch:15}));
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
                XLSX.writeFile(wb, `è£…ä¿®è®°è´¦_${sheetName}_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            bindToggles();
            fillProjectSelect();
            refreshUI();
            
            if (typeof FilterState !== 'undefined') {
                setTimeout(() => { FilterState.init(); }, 100);
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
