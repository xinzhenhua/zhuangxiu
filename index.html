<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>è£…ä¿®è®°è´¦ Â· ç™¾ç‚¼AIæ™ºèƒ½è¯­ä¹‰åŒ¹é…</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* ========== é»‘è‰²æç®€ä¸»ä¹‰ Â· ç§»åŠ¨ä¼˜å…ˆ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        body {
            background-color: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 16px 100px;
        }

        /* å¤´éƒ¨ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0 20px;
            border-bottom: 1px solid #2a2a2a;
            margin-bottom: 24px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 1px;
        }
        .header h1 span {
            color: #00d4aa;
            font-weight: 600;
        }
        .header-actions {
            display: flex;
            gap: 12px;
        }
        .btn-add-project {
            background-color: #00d4aa;
            color: #0a0a0a;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 20px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,212,170,0.25);
        }
        .btn-add-project:hover {
            transform: scale(1.05);
        }

        /* ä»ªè¡¨ç›˜ */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 28px;
        }
        @media (min-width: 769px) {
            .dashboard {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        .dashboard-card {
            background: #161616;
            border-radius: 16px;
            padding: 18px 14px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.3);
        }
        .dashboard-card h3 {
            font-size: 14px;
            font-weight: 400;
            color: #a0a0a0;
            margin-bottom: 8px;
        }
        .dashboard-card .value {
            font-size: 24px;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 4px;
            word-break: break-word;
        }
        .dashboard-card .profit { color: #00d4aa; }
        .dashboard-card .loss { color: #ff6b6b; }
        .dashboard-card .warning { color: #ffd93d; }
        .dashboard-card .subtext {
            font-size: 12px;
            color: #8a8a8a;
        }

        /* åº”æ”¶è´¦æ¬¾æ¨¡å— */
        .receivable-section {
            background: #161616;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #ffd93d40;
            box-shadow: 0 8px 20px rgba(255,217,61,0.1);
        }
        .receivable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .receivable-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #ffd93d;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .receivable-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .receivable-card {
            background: #1e1e1e;
            border-radius: 16px;
            padding: 16px;
            border-left: 4px solid;
        }
        .receivable-card.overdue {
            border-left-color: #ff6b6b;
        }
        .receivable-card.upcoming {
            border-left-color: #ffd93d;
        }
        .receivable-card h4 {
            font-size: 13px;
            color: #b0b0b0;
            margin-bottom: 8px;
        }
        .receivable-card .amount {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .receivable-card .amount.overdue { color: #ff6b6b; }
        .receivable-card .amount.upcoming { color: #ffd93d; }
        .receivable-card .count {
            font-size: 12px;
            color: #8a8a8a;
        }
        .receivable-table-container {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 12px;
            background: #1a1a1a;
        }
        .receivable-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .receivable-table th {
            color: #b0b0b0;
            font-weight: 400;
            text-align: left;
            padding: 14px 12px;
            border-bottom: 1px solid #333;
            background: #1a1a1a;
            position: sticky;
            top: 0;
        }
        .receivable-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #2a2a2a;
        }
        .receivable-table tr:hover {
            background: #252525;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-overdue {
            background: #ff6b6b20;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        .status-upcoming {
            background: #ffd93d20;
            color: #ffd93d;
            border: 1px solid #ffd93d;
        }
        .status-normal {
            background: #00d4aa20;
            color: #00d4aa;
            border: 1px solid #00d4aa;
        }
        .status-paid {
            background: #4dabf720;
            color: #4dabf7;
            border: 1px solid #4dabf7;
        }

        /* åŒå›¾è¡¨å¸ƒå±€ */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (min-width: 1024px) {
            .charts-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        .chart-box {
            background: #161616;
            border-radius: 20px;
            padding: 20px 16px;
            height: 400px;
            position: relative;
        }
        .chart-box h3 {
            font-size: 16px;
            color: #ccc;
            margin-bottom: 12px;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* è¡¨æ ¼åŒºåŸŸ */
        .table-container {
            background: #161616;
            border-radius: 24px;
            padding: 20px 16px;
            margin-bottom: 20px;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .table-title-area {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .btn-export {
            background: transparent;
            color: #00d4aa;
            border: 1px solid #00d4aa;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-export:hover {
            background: #00d4aa;
            color: #0a0a0a;
        }
        .table-tabs {
            display: flex;
            gap: 8px;
            background: #252525;
            padding: 4px;
            border-radius: 30px;
        }
        .tab-btn {
            background: transparent;
            border: none;
            color: #aaa;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            transition: 0.2s;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #00d4aa;
            color: #0a0a0a;
            font-weight: 600;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .data-table th {
            color: #a0a0a0;
            font-weight: 400;
            text-align: left;
            padding: 12px 6px 6px;
            border-bottom: 1px solid #333;
        }
        .data-table td {
            padding: 12px 6px;
            border-bottom: 1px solid #2a2a2a;
        }
        .profit-cell { color: #00d4aa; }
        .loss-cell { color: #ff6b6b; }
        .warning-cell { color: #ffd93d; }
        .action-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .btn-edit, .btn-delete {
            background: transparent;
            border: 1px solid;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
        }
        .btn-edit { color: #4dabf7; border-color: #4dabf7; }
        .btn-delete { color: #ff6b6b; border-color: #ff6b6b; }

        /* å›ºå®šåº•éƒ¨ Â· äººæ°‘å¸å¤§æŒ‰é’® */
        .fab-transaction {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 70px;
            height: 70px;
            background: #00d4aa;
            border: none;
            border-radius: 50%;
            color: #0a0a0a;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 8px 20px rgba(0,212,170,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            z-index: 999;
        }
        .fab-transaction:hover {
            transform: scale(1.1);
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a1a;
            width: 92%;
            max-width: 500px;
            border-radius: 28px;
            padding: 28px 24px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .modal-header h2 {
            font-size: 22px;
            font-weight: 500;
        }
        .btn-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 28px;
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            color: #b0b0b0;
            margin-bottom: 6px;
            font-size: 15px;
        }
        .form-control {
            width: 100%;
            padding: 14px 16px;
            background: #262626;
            border: 1px solid #3a3a3a;
            border-radius: 14px;
            color: white;
            font-size: 16px;
        }
        .form-control:focus {
            border-color: #00d4aa;
            outline: none;
        }
        .btn-submit {
            background: #00d4aa;
            color: #0a0a0a;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 40px;
            font-weight: 700;
            font-size: 17px;
            margin-top: 10px;
            cursor: pointer;
        }
        .btn-submit:hover {
            background: #00b894;
        }

        /* åˆåŒæ”¶æ¬¾èŠ‚ç‚¹ */
        .milestone-section {
            margin-top: 20px;
            border-top: 1px solid #3a3a3a;
            padding-top: 20px;
        }
        .milestone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .milestone-header h4 {
            color: #00d4aa;
            font-size: 16px;
        }
        .btn-add-milestone {
            background: transparent;
            color: #00d4aa;
            border: 1px solid #00d4aa;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        .milestone-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .milestone-item {
            background: #262626;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .milestone-info {
            flex: 1;
        }
        .milestone-date {
            color: #00d4aa;
            font-size: 14px;
            font-weight: 600;
        }
        .milestone-amount {
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            margin-top: 4px;
        }
        .milestone-actions {
            display: flex;
            gap: 8px;
        }
        .btn-remove-milestone {
            background: transparent;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
            border-radius: 16px;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
        }
        .milestone-total {
            margin-top: 12px;
            padding: 12px;
            background: #1e2a2a;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #00d4aa;
            font-weight: 600;
        }

        /* è¯­éŸ³è¾“å…¥ */
        .voice-hero {
            background: linear-gradient(145deg, #1e2a2a, #141818);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid #00d4aa40;
        }
        .voice-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #00d4aa;
            border: none;
            font-size: 28px;
            color: #0a0a0a;
            flex-shrink: 0;
            transition: 0.2s;
            cursor: pointer;
            box-shadow: 0 0 0 0 rgba(0,212,170,0.5);
        }
        .voice-btn.listening {
            background: #ff6b6b;
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 #ff6b6b; }
            70% { box-shadow: 0 0 0 14px #ff6b6b00; }
        }
        .voice-info {
            flex: 1;
        }
        .voice-info h4 {
            color: #00d4aa;
            font-size: 17px;
            margin-bottom: 5px;
        }
        .voice-info p {
            color: #b0b0b0;
            font-size: 13px;
        }
        .voice-status {
            margin-top: 8px;
            color: #ccc;
            font-size: 14px;
            min-height: 24px;
        }

        /* è´¹ç”¨ç±»å‹æ ‡ç­¾ */
        .category-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .category-tag {
            background: #2a2a2a;
            padding: 8px 18px;
            border-radius: 30px;
            font-size: 14px;
            color: #ddd;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .category-tag:hover {
            background: #3a3a3a;
            transform: translateY(-1px);
        }
        .category-tag.active {
            background: #00d4aa;
            color: #0a0a0a;
            font-weight: 600;
            border: 1px solid #00d4aa;
            box-shadow: 0 0 10px rgba(0,212,170,0.3);
        }
        .category-tag .remove-tag {
            font-size: 14px;
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
        }
        .category-tag:hover .remove-tag {
            background: rgba(255,255,255,0.2);
        }
        .custom-category-input {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .btn-add-category {
            background: #3a3a3a;
            border: none;
            border-radius: 20px;
            padding: 0 20px;
            color: white;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-add-category:hover {
            background: #4a4a4a;
        }

        /* è¯­éŸ³ç¡®è®¤æ¡† */
        .confirm-box {
            background: #1e1e1e;
            border-radius: 18px;
            padding: 20px;
            margin: 10px 0;
        }
        .voice-result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #333;
        }
        .voice-match-hint {
            background: #00d4aa20;
            border-left: 4px solid #00d4aa;
            padding: 12px;
            margin-top: 12px;
            border-radius: 8px;
            color: #ddd;
            font-size: 13px;
        }
        .confirm-buttons {
            display: flex;
            gap: 16px;
            margin-top: 28px;
        }
        .btn-confirm, .btn-modify {
            flex: 1;
            padding: 14px;
            border-radius: 40px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-confirm { background: #00d4aa; color: #0a0a0a; }
        .btn-modify { background: #3a3a3a; color: white; }
        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ========== å¤´éƒ¨ ========= -->
        <div class="header">
            <h1>è£…ä¿®<span>è®°è´¦Â·ç™¾ç‚¼AI</span></h1>
            <div class="header-actions">
                <button class="btn-add-project" id="addProjectBtn" title="æ–°å¢é¡¹ç›®"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <!-- ========== ä»ªè¡¨ç›˜ ========= -->
        <div class="dashboard">
            <div class="dashboard-card"><h3>ğŸ“¦ æ€»é¡¹ç›®</h3><div class="value" id="totalProjects">0</div><div class="subtext">è¿›è¡Œä¸­</div></div>
            <div class="dashboard-card"><h3>ğŸ’° æ€»æ”¶å…¥</h3><div class="value profit" id="totalIncome">Â¥0</div><div class="subtext">ç´¯è®¡</div></div>
            <div class="dashboard-card"><h3>ğŸ“‰ æ€»æ”¯å‡º</h3><div class="value loss" id="totalExpense">Â¥0</div><div class="subtext">ç´¯è®¡</div></div>
            <div class="dashboard-card"><h3>ğŸ“Š æ¯›åˆ©æ¶¦</h3><div class="value profit" id="totalProfit">Â¥0</div><div class="subtext">æ”¶å…¥-æ”¯å‡º</div></div>
        </div>

        <!-- ========== åº”æ”¶è´¦æ¬¾æ¨¡å— ========= -->
        <div class="receivable-section" id="receivableSection">
            <div class="receivable-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> åº”æ”¶è´¦æ¬¾æé†’</h2>
                <span style="color:#ffd93d; font-size:14px;" id="receivableRefreshTime">å®æ—¶æ›´æ–°</span>
            </div>
            
            <div class="receivable-stats">
                <div class="receivable-card">
                    <h4>ğŸ“‹ å¾…æ”¶æ€»é¢</h4>
                    <div class="amount warning" id="totalReceivable">Â¥0</div>
                    <div class="count" id="totalReceivableCount">0ä¸ªé¡¹ç›®</div>
                </div>
                <div class="receivable-card overdue">
                    <h4>âš ï¸ é€¾æœŸé‡‘é¢</h4>
                    <div class="amount overdue" id="overdueAmount">Â¥0</div>
                    <div class="count" id="overdueCount">0ç¬”é€¾æœŸ</div>
                </div>
                <div class="receivable-card upcoming">
                    <h4>ğŸ“… å³å°†åˆ°æœŸ</h4>
                    <div class="amount upcoming" id="upcomingAmount">Â¥0</div>
                    <div class="count" id="upcomingCount">7å¤©å†…åˆ°æœŸ</div>
                </div>
            </div>
            
            <div class="receivable-table-container">
                <table class="receivable-table">
                    <thead>
                        <tr>
                            <th>é¡¹ç›®åç§°</th>
                            <th>æ”¶æ¬¾æ—¥æœŸ</th>
                            <th>åº”æ”¶é‡‘é¢</th>
                            <th>å·²æ”¶é‡‘é¢</th>
                            <th>å¾…æ”¶é‡‘é¢</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="receivableTableBody">
                        <tr><td colspan="6" class="empty-state"><i class="fas fa-file-invoice-dollar"></i><br>æš‚æ— åº”æ”¶è´¦æ¬¾</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== åŒå›¾ ========= -->
        <div class="charts-container">
            <div class="chart-box">
                <h3><i class="fas fa-chart-bar" style="color:#00d4aa;"></i> é¡¹ç›®åˆ©æ¶¦å¯¹æ¯”</h3>
                <canvas id="profitChart"></canvas>
            </div>
            <div class="chart-box">
                <h3><i class="fas fa-chart-pie" style="color:#ffd93d;"></i> æˆæœ¬ç±»å‹å æ¯”</h3>
                <canvas id="costPieChart"></canvas>
            </div>
        </div>

        <!-- ========== ä¸‰åˆä¸€æ™ºèƒ½è¡¨æ ¼ ========= -->
        <div class="table-container">
            <div class="table-header">
                <div class="table-title-area">
                    <div style="font-size:18px; font-weight:500;" id="tableTitle">ğŸ“‹ ç»¼åˆæŠ¥è¡¨</div>
                    <button class="btn-export" id="exportBtn"><i class="fas fa-file-excel"></i> å¯¼å‡ºExcel</button>
                </div>
                <div class="table-tabs">
                    <button class="tab-btn active" id="summaryToggle">ç»¼åˆ</button>
                    <button class="tab-btn" id="projectsToggle">é¡¹ç›®</button>
                    <button class="tab-btn" id="transactionsToggle">æ”¶æ”¯</button>
                </div>
            </div>

            <!-- ç»¼åˆæŠ¥è¡¨ -->
            <table class="data-table" id="summaryTable">
                <thead><tr><th>é¡¹ç›®</th><th>åˆåŒæ€»é¢</th><th>å·²æ”¶</th><th>å¾…æ”¶</th><th>æ”¯å‡º</th><th>åˆ©æ¶¦</th><th>æ¯›åˆ©ç‡</th></tr></thead>
                <tbody id="summaryTableBody"><tr><td colspan="7" class="empty-state"><i class="fas fa-chart-line"></i><br>æš‚æ— é¡¹ç›®</td></tr></tbody>
            </table>
            <!-- é¡¹ç›®åˆ—è¡¨ -->
            <table class="data-table" id="projectsTable" style="display:none;">
                <thead><tr><th>é¡¹ç›®åç§°</th><th>åˆåŒæ€»é¢</th><th>æ”¶æ¬¾èŠ‚ç‚¹</th><th>å·²æ”¶</th><th>å¾…æ”¶</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="projectsTableBody"></tbody>
            </table>
            <!-- æ”¶æ”¯è®°å½• -->
            <table class="data-table" id="transactionsTable" style="display:none;">
                <thead><tr><th>æ—¥æœŸ</th><th>é¡¹ç›®</th><th>ç±»å‹</th><th>é‡‘é¢</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="transactionsTableBody"></tbody>
            </table>
        </div>

        <!-- å›ºå®šåº•éƒ¨ Â· äººæ°‘å¸å¤§æŒ‰é’® -->
        <button class="fab-transaction" id="addTransactionBtn"><i class="fas fa-yen-sign"></i></button>
    </div>

    <!-- ========== æ¨¡æ€æ¡†ï¼šé¡¹ç›®ç®¡ç† ========= -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="projectModalTitle">â• æ–°å»ºé¡¹ç›®</h2><button class="btn-close" id="closeProjectModal">&times;</button></div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="form-group"><label>ğŸ—ï¸ é¡¹ç›®åç§°</label><input type="text" id="projectName" class="form-control" placeholder="å¦‚ï¼šé˜³å…‰èŠ±å›­12-302" required></div>
                <div class="form-group"><label>ğŸ’° åˆåŒæ€»é¢ / é¢„ç®— (å…ƒ)</label><input type="number" id="projectBudget" class="form-control" placeholder="150000" min="0" step="0.01" required></div>
                
                <div class="milestone-section">
                    <div class="milestone-header">
                        <h4><i class="fas fa-file-signature"></i> æ”¶æ¬¾è®¡åˆ’</h4>
                        <button type="button" class="btn-add-milestone" id="addMilestoneBtn">
                            <i class="fas fa-plus"></i> æ·»åŠ èŠ‚ç‚¹
                        </button>
                    </div>
                    <div id="milestoneList" class="milestone-list"></div>
                    <div class="milestone-total">
                        <span>åˆè®¡é‡‘é¢</span>
                        <span id="totalAmountDisplay">Â¥0.00</span>
                    </div>
                    <div id="milestoneWarning" style="color:#ffd93d; font-size:13px; margin-top:8px; display:none;">
                        <i class="fas fa-exclamation-triangle"></i> æ”¶æ¬¾èŠ‚ç‚¹æ€»é¢ä¸åˆåŒæ€»é¢ä¸ç¬¦
                    </div>
                    <input type="hidden" id="projectMilestones" value="[]">
                </div>
                
                <button type="submit" class="btn-submit" id="projectSubmitBtn">ä¿å­˜é¡¹ç›®</button>
            </form>
        </div>
    </div>

    <!-- ========== æ·»åŠ æ”¶æ¬¾èŠ‚ç‚¹æ¨¡æ€æ¡† ========= -->
    <div class="modal" id="milestoneModal">
        <div class="modal-content">
            <div class="modal-header"><h2>ğŸ“… æ·»åŠ æ”¶æ¬¾èŠ‚ç‚¹</h2><button class="btn-close" id="closeMilestoneModal">&times;</button></div>
            <form id="milestoneForm">
                <div class="form-group"><label>ğŸ“… æ”¶æ¬¾æ—¥æœŸ</label><input type="date" id="milestoneDate" class="form-control" required></div>
                <div class="form-group"><label>ğŸ’° æ”¶æ¬¾é‡‘é¢ (å…ƒ)</label><input type="number" id="milestoneAmount" class="form-control" placeholder="50000" min="0" step="0.01" required></div>
                <div class="form-group"><label>ğŸ“ å¤‡æ³¨</label><input type="text" id="milestoneNote" class="form-control" placeholder="å¦‚ï¼šé¦–ä»˜æ¬¾ã€è¿›åº¦æ¬¾"></div>
                <button type="submit" class="btn-submit">æ·»åŠ èŠ‚ç‚¹</button>
            </form>
        </div>
    </div>

    <!-- ========== æ¨¡æ€æ¡†ï¼šæ”¶æ”¯è®°å½• ========= -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="transactionModalTitle">ğŸ’° æ”¶æ”¯è®°å½•</h2><button class="btn-close" id="closeTransactionModal">&times;</button></div>
            
            <div class="voice-hero">
                <button class="voice-btn" id="voiceInputBtn"><i class="fas fa-microphone"></i></button>
                <div class="voice-info">
                    <h4><i class="fas fa-brain"></i> ç™¾ç‚¼AIæ™ºèƒ½è¯­ä¹‰åŒ¹é…</h4>
                    <p>ç‚¹å‡»éº¦å…‹é£è¯­éŸ³è¾“å…¥ï¼Œæˆ–æ‰‹åŠ¨é€‰æ‹©ä¸‹æ–¹æ ‡ç­¾</p>
                </div>
            </div>
            <div class="voice-status" id="voiceStatus">âœ¨ ç¤ºä¾‹ï¼šâ€œé˜³å…‰èŠ±å›­ ææ–™è´¹ ä¸‰åƒäºŒ 25å¹´3æœˆ5å·â€</div>

            <form id="transactionForm">
                <input type="hidden" id="transactionId">
                <div class="form-group"><label>ğŸ“… æ—¥æœŸ</label><input type="date" id="transactionDate" class="form-control" required></div>
                <div class="form-group"><label>ğŸ—ï¸ é¡¹ç›®</label><select id="transactionProject" class="form-control" required><option value="">è¯·é€‰æ‹©</option></select></div>
                <div class="form-group">
                    <label>ğŸ·ï¸ è´¹ç”¨ç±»å‹ <span style="color:#00d4aa; font-size:12px;">ï¼ˆç‚¹å‡»æ ‡ç­¾æ‰‹åŠ¨é€‰æ‹©ï¼‰</span></label>
                    <div class="category-tags" id="categoryTags"></div>
                    <div class="custom-category-input">
                        <input type="text" id="customCategory" class="form-control" placeholder="è‡ªå®šä¹‰ç±»å‹">
                        <button type="button" class="btn-add-category" id="addCategoryBtn">æ·»åŠ </button>
                    </div>
                    <input type="hidden" id="transactionType" value="æ”¶å…¥">
                </div>
                <div class="form-group"><label>ğŸ’° é‡‘é¢ (å…ƒ)</label><input type="number" id="transactionAmount" class="form-control" placeholder="0.00" min="0" step="0.01" required></div>
                <button type="submit" class="btn-submit" id="transactionSubmitBtn">âœ… ä¿å­˜è®°å½•</button>
            </form>
        </div>
    </div>

    <!-- ========== è¯­éŸ³ç¡®è®¤æ¨¡æ€æ¡† ========= -->
    <div class="modal" id="voiceConfirmModal">
        <div class="modal-content">
            <div class="modal-header"><h2>ğŸ¤ AIæ™ºèƒ½åŒ¹é…ç»“æœ</h2><button class="btn-close" id="closeVoiceConfirmModal">&times;</button></div>
            <div class="confirm-box" id="voiceConfirmContent"></div>
            <div class="confirm-buttons">
                <button class="btn-modify" id="modifyVoiceResultBtn">ä¿®æ”¹</button>
                <button class="btn-confirm" id="confirmVoiceResultBtn">ç¡®è®¤å¹¶æäº¤</button>
            </div>
        </div>
    </div>

    <script>
        // ================= æ³¨å†ŒChart.jsæ•°æ®æ ‡ç­¾æ’ä»¶ =================
        Chart.register(ChartDataLabels);
        
        // ================= é˜¿é‡Œäº‘ç™¾ç‚¼å¤§æ¨¡å‹ =================
        const BAILIAN_API_KEY = 'sk-cbfb73b5ae5b41608922e86705340311';
        const BAILIAN_BASE_URL = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
        
        // ========== âœ… ä¿®å¤1ï¼šè·å–å½“å¤©æ—¥æœŸå‡½æ•° ==========
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ========== æ™ºèƒ½æ—¥æœŸè§£æ ==========
        function parseNaturalDate(dateText) {
            if (!dateText) return getTodayDate();
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateText)) return dateText;
            
            const chineseDateMatch = dateText.match(/(\d{2,4})?å¹´?(\d{1,2})æœˆ(\d{1,2})[å·æ—¥]?/);
            if (chineseDateMatch) {
                let year = chineseDateMatch[1] ? parseInt(chineseDateMatch[1]) : currentYear;
                if (year < 100) year += 2000;
                const month = parseInt(chineseDateMatch[2]);
                const day = parseInt(chineseDateMatch[3]);
                return `${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
            }
            
            if (dateText.includes('æ˜¨å¤©')) {
                const date = new Date(today); date.setDate(today.getDate() - 1); return date.toISOString().split('T')[0];
            }
            if (dateText.includes('ä»Šå¤©')) return getTodayDate();
            if (dateText.includes('æ˜å¤©')) {
                const date = new Date(today); date.setDate(today.getDate() + 1); return date.toISOString().split('T')[0];
            }
            
            return getTodayDate();
        }

        // ========== ä¸­æ–‡æ•°å­—è½¬é˜¿æ‹‰ä¼¯æ•°å­— ==========
        function chineseToNumber(chineseStr) {
            if (!chineseStr) return 0;
            
            const chineseNum = {
                'é›¶':0,'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,
                'å':10,'ç™¾':100,'åƒ':1000,'ä¸‡':10000,'äº¿':100000000,'ä¸¤':2,'ä¿©':2
            };
            
            const arabicMatch = chineseStr.match(/\d+/g);
            if (arabicMatch) return parseInt(arabicMatch[arabicMatch.length - 1]);
            
            if (chineseStr.includes('åƒ') || chineseStr.includes('ç™¾') || chineseStr.includes('å')) {
                let result = 0, current = 0;
                for (let i = 0; i < chineseStr.length; i++) {
                    const char = chineseStr[i];
                    if (chineseNum[char] !== undefined) {
                        if (chineseNum[char] >= 10) {
                            if (current === 0) current = 1;
                            result += current * chineseNum[char];
                            current = 0;
                        } else {
                            current = chineseNum[char];
                        }
                    }
                }
                if (current > 0) result += current;
                return result || 0;
            }
            return 0;
        }

        // ========== æ•°æ®æŒä¹…åŒ– ==========
        const Storage = {
            load: key => JSON.parse(localStorage.getItem(key) || '[]'),
            save: (key, data) => localStorage.setItem(key, JSON.stringify(data))
        };

        // ========== å…¨å±€çŠ¶æ€ ==========
        const AppState = {
            projects: Storage.load('projects') || [],
            transactions: Storage.load('transactions') || [],
            expenseTypes: Storage.load('expenseTypes') || ['ææ–™è´¹', 'äººå·¥è´¹', 'å…¶ä»–è´¹ç”¨'],

            // âœ… ä¿®å¤ï¼šé¡¹ç›®æ“ä½œ - å®Œå…¨æ›¿æ¢æ—§æ•°æ® + å¼ºåˆ¶è§¦å‘æ›´æ–°
            addProject(id, name, budget, milestones) {
                const proj = { 
                    id: id || Date.now(), 
                    name, 
                    budget: parseFloat(budget),
                    milestones: milestones || [], 
                    createdAt: id ? this.projects.find(p => p.id === id)?.createdAt || new Date().toISOString() : new Date().toISOString()
                };
                
                if (id) { 
                    // ç¼–è¾‘æ¨¡å¼ï¼šå®Œå…¨æ›¿æ¢æ—§é¡¹ç›®
                    const index = this.projects.findIndex(p => p.id === id);
                    if (index !== -1) {
                        this.projects[index] = proj;
                    }
                } else {
                    this.projects.push(proj);
                }
                
                Storage.save('projects', this.projects);
                return proj;
            },
            
            deleteProject(id) {
                this.transactions = this.transactions.filter(t => t.projectId !== id);
                this.projects = this.projects.filter(p => p.id !== id);
                Storage.save('projects', this.projects); 
                Storage.save('transactions', this.transactions);
            },
            
            // âœ… ä¿®å¤ï¼šäº¤æ˜“æ“ä½œ - å®Œå…¨æ›¿æ¢æ—§æ•°æ® + å¼ºåˆ¶è§¦å‘æ›´æ–°
            addTransaction(id, date, projectId, type, amount) {
                const trans = { 
                    id: id || Date.now(), 
                    date, 
                    projectId: parseInt(projectId), 
                    type, 
                    amount: parseFloat(amount) 
                };
                
                if (id) { 
                    // ç¼–è¾‘æ¨¡å¼ï¼šå®Œå…¨æ›¿æ¢æ—§äº¤æ˜“
                    const index = this.transactions.findIndex(t => t.id === id);
                    if (index !== -1) {
                        this.transactions[index] = trans;
                    }
                } else {
                    this.transactions.push(trans);
                }
                
                Storage.save('transactions', this.transactions);
                return trans;
            },
            
            deleteTransaction(id) {
                this.transactions = this.transactions.filter(t => t.id !== id);
                Storage.save('transactions', this.transactions);
            },
            
            addExpenseType(type) { 
                if(!this.expenseTypes.includes(type) && type.trim()){ 
                    this.expenseTypes.push(type); 
                    Storage.save('expenseTypes', this.expenseTypes); 
                } 
            },
            
            deleteExpenseType(type) { 
                if(this.expenseTypes.length > 1) { 
                    this.expenseTypes = this.expenseTypes.filter(t => t !== type); 
                    Storage.save('expenseTypes', this.expenseTypes); 
                } else alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªè´¹ç”¨ç±»å‹');
            },
            
            // é¡¹ç›®ç»Ÿè®¡
            getProjectStats(pid) {
                const p = this.projects.find(p => p.id === pid); 
                if(!p) return null;
                
                const ts = this.transactions.filter(t => t.projectId === pid);
                const income = ts.filter(t => t.type === 'æ”¶å…¥').reduce((s,t)=>s+t.amount,0);
                const expense = ts.filter(t => t.type !== 'æ”¶å…¥').reduce((s,t)=>s+t.amount,0);
                
                const contractTotal = p.budget || 0;
                const pendingIncome = Math.max(0, contractTotal - income);
                
                return { 
                    ...p, 
                    contractTotal,
                    pendingIncome,
                    income, 
                    expense, 
                    profit: income - expense, 
                    profitMargin: contractTotal > 0 ? ((income - expense) / contractTotal * 100) : 0 
                };
            },
            
            getAllStats() { 
                return this.projects.map(p => this.getProjectStats(p.id)); 
            },
            
            getOverallStats() {
                const all = this.getAllStats();
                return {
                    totalProjects: this.projects.length,
                    totalIncome: all.reduce((s,st)=>s+st.income,0),
                    totalExpense: all.reduce((s,st)=>s+st.expense,0),
                    totalProfit: all.reduce((s,st)=>s+st.profit,0)
                };
            },
            
            getCostTypeAnalysis() {
                const map = {};
                this.transactions.filter(t => t.type !== 'æ”¶å…¥').forEach(t => { 
                    map[t.type] = (map[t.type]||0) + t.amount; 
                });
                return Object.keys(map).map(k=>({type:k, amount:map[k]})).sort((a,b)=>b.amount-a.amount);
            },

            // åº”æ”¶è´¦æ¬¾æ™ºèƒ½ç´¯è®¡é€»è¾‘
            getReceivableAnalysis() {
                const today = new Date();
                const sevenDaysLater = new Date(today);
                sevenDaysLater.setDate(today.getDate() + 7);
                
                let totalReceivable = 0;
                let overdueAmount = 0;
                let upcomingAmount = 0;
                let overdueCount = 0;
                let upcomingCount = 0;
                let receivableItems = [];
                
                this.projects.forEach(project => {
                    const stats = this.getProjectStats(project.id);
                    if (!stats) return;
                    
                    const pendingIncome = stats.pendingIncome;
                    if (pendingIncome <= 0) return;
                    
                    totalReceivable += pendingIncome;
                    
                    if (!project.milestones || project.milestones.length === 0) {
                        receivableItems.push({
                            projectId: project.id,
                            projectName: project.name,
                            dueDate: project.createdAt.split('T')[0],
                            originalAmount: project.budget,
                            receivedAmount: stats.income,
                            pendingAmount: pendingIncome,
                            note: 'åˆåŒæ€»é¢',
                            status: new Date(project.createdAt) < today ? 'overdue' : 'normal'
                        });
                        if (new Date(project.createdAt) < today) {
                            overdueAmount += pendingIncome;
                            overdueCount++;
                        }
                        return;
                    }
                    
                    const sortedMilestones = [...project.milestones].sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    const projectIncomes = this.transactions
                        .filter(t => t.projectId === project.id && t.type === 'æ”¶å…¥')
                        .sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    let accumulatedIncome = 0;
                    let incomeIndex = 0;
                    
                    sortedMilestones.forEach((milestone, index) => {
                        const milestoneDate = new Date(milestone.date);
                        const milestoneAmount = milestone.amount;
                        
                        let receivedBeforeMilestone = 0;
                        while (incomeIndex < projectIncomes.length) {
                            const income = projectIncomes[incomeIndex];
                            const incomeDate = new Date(income.date);
                            
                            const nextMilestoneDate = index < sortedMilestones.length - 1 
                                ? new Date(sortedMilestones[index + 1].date) 
                                : null;
                            
                            if (!nextMilestoneDate || incomeDate < nextMilestoneDate) {
                                receivedBeforeMilestone += income.amount;
                                incomeIndex++;
                            } else {
                                break;
                            }
                        }
                        
                        const receivedForMilestone = Math.min(receivedBeforeMilestone, milestoneAmount);
                        const pendingForMilestone = milestoneAmount - receivedForMilestone;
                        
                        if (pendingForMilestone > 0) {
                            let status = 'normal';
                            
                            if (milestoneDate < today && receivedBeforeMilestone < milestoneAmount) {
                                status = 'overdue';
                                overdueAmount += pendingForMilestone;
                                overdueCount++;
                            } else if (milestoneDate <= sevenDaysLater && milestoneDate >= today) {
                                status = 'upcoming';
                                upcomingAmount += pendingForMilestone;
                                upcomingCount++;
                            }
                            
                            receivableItems.push({
                                projectId: project.id,
                                projectName: project.name,
                                dueDate: milestone.date,
                                originalAmount: milestoneAmount,
                                receivedAmount: receivedForMilestone,
                                pendingAmount: pendingForMilestone,
                                note: milestone.note || '',
                                status
                            });
                        } else {
                            receivableItems.push({
                                projectId: project.id,
                                projectName: project.name,
                                dueDate: milestone.date,
                                originalAmount: milestoneAmount,
                                receivedAmount: milestoneAmount,
                                pendingAmount: 0,
                                note: milestone.note || '',
                                status: 'paid'
                            });
                        }
                        
                        accumulatedIncome = receivedBeforeMilestone;
                    });
                });
                
                receivableItems.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                
                return {
                    totalReceivable,
                    overdueAmount,
                    upcomingAmount,
                    overdueCount,
                    upcomingCount,
                    items: receivableItems
                };
            }
        };

        // ========== DOM ç»‘å®š ==========
        const DOM = {
            totalProjects: document.getElementById('totalProjects'), 
            totalIncome: document.getElementById('totalIncome'),
            totalExpense: document.getElementById('totalExpense'), 
            totalProfit: document.getElementById('totalProfit'),
            
            totalReceivable: document.getElementById('totalReceivable'),
            totalReceivableCount: document.getElementById('totalReceivableCount'),
            overdueAmount: document.getElementById('overdueAmount'),
            overdueCount: document.getElementById('overdueCount'),
            upcomingAmount: document.getElementById('upcomingAmount'),
            upcomingCount: document.getElementById('upcomingCount'),
            receivableTableBody: document.getElementById('receivableTableBody'),
            
            summaryTable: document.getElementById('summaryTable'), 
            summaryBody: document.getElementById('summaryTableBody'),
            projectsTable: document.getElementById('projectsTable'), 
            projectsBody: document.getElementById('projectsTableBody'),
            transactionsTable: document.getElementById('transactionsTable'), 
            transactionsBody: document.getElementById('transactionsTableBody'),
            tableTitle: document.getElementById('tableTitle'), 
            summaryToggle: document.getElementById('summaryToggle'),
            projectsToggle: document.getElementById('projectsToggle'), 
            transactionsToggle: document.getElementById('transactionsToggle'),
            addProjectBtn: document.getElementById('addProjectBtn'), 
            addTransactionBtn: document.getElementById('addTransactionBtn'),
            exportBtn: document.getElementById('exportBtn'),
            projectModal: document.getElementById('projectModal'), 
            transactionModal: document.getElementById('transactionModal'),
            milestoneModal: document.getElementById('milestoneModal'),
            voiceConfirmModal: document.getElementById('voiceConfirmModal'),
            closeProjectModal: document.getElementById('closeProjectModal'), 
            closeTransactionModal: document.getElementById('closeTransactionModal'),
            closeMilestoneModal: document.getElementById('closeMilestoneModal'),
            closeVoiceConfirm: document.getElementById('closeVoiceConfirmModal'),
            projectForm: document.getElementById('projectForm'), 
            projectId: document.getElementById('projectId'),
            projectName: document.getElementById('projectName'), 
            projectBudget: document.getElementById('projectBudget'),
            projectMilestones: document.getElementById('projectMilestones'),
            milestoneList: document.getElementById('milestoneList'),
            totalAmountDisplay: document.getElementById('totalAmountDisplay'),
            milestoneWarning: document.getElementById('milestoneWarning'),
            projectModalTitle: document.getElementById('projectModalTitle'), 
            projectSubmitBtn: document.getElementById('projectSubmitBtn'),
            addMilestoneBtn: document.getElementById('addMilestoneBtn'),
            milestoneForm: document.getElementById('milestoneForm'),
            milestoneDate: document.getElementById('milestoneDate'),
            milestoneAmount: document.getElementById('milestoneAmount'),
            milestoneNote: document.getElementById('milestoneNote'),
            transactionForm: document.getElementById('transactionForm'), 
            transactionId: document.getElementById('transactionId'),
            transactionDate: document.getElementById('transactionDate'), 
            transactionProject: document.getElementById('transactionProject'),
            transactionAmount: document.getElementById('transactionAmount'), 
            transactionType: document.getElementById('transactionType'),
            transactionModalTitle: document.getElementById('transactionModalTitle'), 
            transactionSubmitBtn: document.getElementById('transactionSubmitBtn'),
            categoryTags: document.getElementById('categoryTags'), 
            customCategory: document.getElementById('customCategory'),
            addCategoryBtn: document.getElementById('addCategoryBtn'), 
            voiceInputBtn: document.getElementById('voiceInputBtn'),
            voiceStatus: document.getElementById('voiceStatus'), 
            voiceConfirmContent: document.getElementById('voiceConfirmContent'),
            modifyBtn: document.getElementById('modifyVoiceResultBtn'), 
            confirmBtn: document.getElementById('confirmVoiceResultBtn')
        };

        // ========== å›¾è¡¨å®ä¾‹ ==========
        let profitChart, costPieChart;

        // ========== å·¥å…·å‡½æ•° ==========
        const formatMoney = (v) => 'Â¥' + v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        const formatNumber = (v) => v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

        // ========== Excelå¯¼å‡º ==========
        function exportToExcel() {
            let data = [], sheetName = '', headers = [];
            
            if (DOM.summaryTable.style.display !== 'none') {
                sheetName = 'ç»¼åˆæŠ¥è¡¨';
                headers = ['é¡¹ç›®åç§°', 'åˆåŒæ€»é¢(å…ƒ)', 'å·²æ”¶(å…ƒ)', 'å¾…æ”¶(å…ƒ)', 'æ”¯å‡º(å…ƒ)', 'æ¯›åˆ©æ¶¦(å…ƒ)', 'æ¯›åˆ©ç‡(%)'];
                const stats = AppState.getAllStats();
                data = stats.map(s => [
                    s.name, s.contractTotal || 0, s.income, s.pendingIncome || 0, s.expense, s.profit, s.profitMargin.toFixed(1)
                ]);
            } else if (DOM.projectsTable.style.display !== 'none') {
                sheetName = 'é¡¹ç›®åˆ—è¡¨';
                headers = ['é¡¹ç›®åç§°', 'åˆåŒæ€»é¢(å…ƒ)', 'æ”¶æ¬¾èŠ‚ç‚¹', 'å·²æ”¶(å…ƒ)', 'å¾…æ”¶(å…ƒ)', 'åˆ›å»ºæ—¶é—´'];
                data = AppState.projects.map(p => {
                    const stats = AppState.getProjectStats(p.id);
                    return [
                        p.name, p.budget || 0,
                        p.milestones ? p.milestones.length : 0,
                        stats?.income || 0,
                        stats?.pendingIncome || 0,
                        new Date(p.createdAt).toLocaleDateString('zh-CN')
                    ];
                });
            } else {
                sheetName = 'æ”¶æ”¯è®°å½•';
                headers = ['æ—¥æœŸ', 'é¡¹ç›®åç§°', 'è´¹ç”¨ç±»å‹', 'é‡‘é¢(å…ƒ)'];
                const sorted = [...AppState.transactions].sort((a,b)=>b.date.localeCompare(a.date));
                data = sorted.map(t => {
                    const proj = AppState.projects.find(p=>p.id===t.projectId);
                    return [t.date, proj?.name || 'æœªçŸ¥é¡¹ç›®', t.type, t.type === 'æ”¶å…¥' ? t.amount : -t.amount];
                });
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            ws['!cols'] = headers.map(() => ({ wch: 15 }));
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, `è£…ä¿®è®°è´¦_${sheetName}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // ========== ç™¾ç‚¼AIè¯­éŸ³ ==========
        const BailianAI = {
            isListening: false, recognition: null,

            init() {
                if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                    DOM.voiceStatus.innerHTML = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³ï¼Œè¯·ç”¨Chrome/Edge';
                    DOM.voiceInputBtn.disabled = true; return false;
                }
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.lang = 'zh-CN'; this.recognition.continuous = false; this.recognition.interimResults = false;
                
                this.recognition.onstart = () => { 
                    this.isListening = true; 
                    DOM.voiceInputBtn.classList.add('listening'); 
                    DOM.voiceStatus.innerHTML = 'ğŸ¤ è†å¬ä¸­â€¦ è¯·è¯´å‡ºè®°è´¦å†…å®¹'; 
                };
                this.recognition.onend = () => { 
                    this.isListening = false; 
                    DOM.voiceInputBtn.classList.remove('listening'); 
                    if (!window.__voiceProcessing) DOM.voiceStatus.innerHTML = 'âœ¨ ç‚¹å‡»éº¦å…‹é£ï¼ŒAIæ™ºèƒ½è¯­ä¹‰åŒ¹é…'; 
                };
                this.recognition.onerror = (e) => { 
                    DOM.voiceStatus.innerHTML = 'âŒ è¯­éŸ³è¯†åˆ«é”™è¯¯: ' + e.error; 
                    this.isListening = false; 
                    DOM.voiceInputBtn.classList.remove('listening'); 
                };
                this.recognition.onresult = (e) => {
                    const text = e.results[0][0].transcript;
                    DOM.voiceStatus.innerHTML = `ğŸ“ è¯†åˆ«æ–‡å­—: "${text}" â†’ AIæ­£åœ¨ç†è§£ä½ çš„æ„æ€...`;
                    this.callBailianLLM(text);
                };
                return true;
            },
            start() { if (this.recognition && !this.isListening) this.recognition.start(); },

            async callBailianLLM(transcript) {
                if (!AppState.projects.length) { 
                    alert('è¯·å…ˆæ·»åŠ é¡¹ç›®ï¼Œå†è¿›è¡Œè¯­éŸ³è®°è´¦'); 
                    DOM.voiceStatus.innerHTML = 'âš ï¸ å°šæœªåˆ›å»ºé¡¹ç›®'; 
                    return; 
                }

                const projectList = AppState.projects.map(p => p.name).join('ã€');
                const expenseTypeList = ['æ”¶å…¥', ...AppState.expenseTypes].join('ã€');
                const today = getTodayDate();

                const prompt = `ä½ æ˜¯ä¸€ä¸ªè£…ä¿®é¡¹ç›®è®°è´¦AIï¼Œä¸“é—¨å¤„ç†è¯­éŸ³è¯†åˆ«åçš„æ–‡å­—ã€‚

ç”¨æˆ·è¯´ï¼š"""${transcript}"""

é¡¹ç›®åˆ—è¡¨ï¼š[${projectList}]
è´¹ç”¨ç±»å‹åˆ—è¡¨ï¼š[${expenseTypeList}]
ä»Šå¤©æ—¥æœŸï¼š${today}

ä»»åŠ¡ï¼š
1. æ—¥æœŸè§£æï¼šè¯†åˆ«å£è¯­åŒ–æ—¥æœŸï¼ˆ25å¹´3æœˆ5å·ã€æ˜¨å¤©ã€ä»Šå¤©ç­‰ï¼‰ï¼Œè¾“å‡ºYYYY-MM-DD
2. é¡¹ç›®åŒ¹é…ï¼šæ ¹æ®å‘éŸ³ç›¸ä¼¼åº¦åŒ¹é…é¡¹ç›®åç§°
3. ç±»å‹åŒ¹é…ï¼šæ ¹æ®å‘éŸ³ç›¸ä¼¼åº¦åŒ¹é…è´¹ç”¨ç±»å‹
4. é‡‘é¢æå–ï¼šæ”¯æŒä¸­æ–‡æ•°å­—ï¼ˆä¸‰åƒäºŒ=3200ï¼‰

åªè¾“å‡ºJSONï¼š{"date":"æ—¥æœŸ","project":"é¡¹ç›®å","type":"ç±»å‹","amount":æ•°å­—}`;

                try {
                    DOM.voiceStatus.innerHTML = 'ğŸ¤– ç™¾ç‚¼AIæ™ºèƒ½åŒ¹é…ä¸­...';
                    const response = await fetch(BAILIAN_BASE_URL, {
                        method: 'POST', 
                        headers: { 
                            'Authorization': `Bearer ${BAILIAN_API_KEY}`, 
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify({ 
                            model: 'qwen-plus', 
                            messages: [{ 
                                role: 'system', 
                                content: 'ä½ æ˜¯è®°è´¦AIï¼Œåªè¾“å‡ºJSONæ ¼å¼' 
                            }, { 
                                role: 'user', 
                                content: prompt 
                            }], 
                            temperature: 0.1 
                        })
                    });
                    
                    if (!response.ok) throw new Error(`APIé”™è¯¯ ${response.status}`);
                    const data = await response.json();
                    let aiText = data.choices?.[0]?.message?.content;
                    if (!aiText) throw new Error('æ— æ³•è§£æAIè¿”å›');

                    const jsonMatch = aiText.match(/\{.*\}/s);
                    if (!jsonMatch) throw new Error('AIæœªè¿”å›åˆæ³•JSON');
                    const result = JSON.parse(jsonMatch[0]);
                    
                    let parsedDate = result.date || parseNaturalDate(transcript);
                    let matchedProject = result.project ? AppState.projects.find(p => p.name === result.project) : null;
                    if (!matchedProject && AppState.projects.length) matchedProject = AppState.projects[0];
                    
                    let amount = result.amount;
                    if (typeof amount === 'string') amount = chineseToNumber(amount);
                    if (!amount) amount = chineseToNumber(transcript);
                    if (!amount) {
                        const nums = transcript.match(/\d+/g);
                        if (nums) amount = parseInt(nums[nums.length-1]);
                        if (transcript.includes('åƒ') && amount < 1000) amount *= 1000;
                        if (transcript.includes('ä¸‡') && amount < 10000) amount *= 10000;
                    }
                    
                    const voiceResult = {
                        transcript, 
                        date: parsedDate || today,
                        project: matchedProject, 
                        type: result.type || 'å…¶ä»–è´¹ç”¨',
                        amount: amount || 0, 
                        confidence: 'high',
                        reason: `æ—¥æœŸ: ${parsedDate}, é¡¹ç›®: ${matchedProject?.name}, ç±»å‹: ${result.type}`
                    };
                    this.showConfirm(voiceResult);
                    DOM.voiceStatus.innerHTML = `âœ… AIæ™ºèƒ½åŒ¹é…å®Œæˆ`;
                } catch (err) {
                    console.error('ç™¾ç‚¼APIè°ƒç”¨å¤±è´¥:', err);
                    DOM.voiceStatus.innerHTML = 'âš ï¸ ç™¾ç‚¼APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ™ºèƒ½åŒ¹é…...';
                    this.smartLocalMatch(transcript);
                }
            },

            smartLocalMatch(transcript) {
                const date = parseNaturalDate(transcript);
                let matchedProject = AppState.projects.find(p => transcript.includes(p.name)) || AppState.projects[0] || null;
                let type = 'å…¶ä»–è´¹ç”¨';
                if (transcript.includes('æ”¶å…¥')||transcript.includes('æ”¶æ¬¾')) type='æ”¶å…¥';
                else if (transcript.includes('ææ–™')) type='ææ–™è´¹';
                else if (transcript.includes('äººå·¥')) type='äººå·¥è´¹';
                
                let amount = chineseToNumber(transcript);
                if (!amount) {
                    const nums = transcript.match(/\d+/g);
                    if (nums) amount = parseInt(nums[nums.length-1]);
                    if (transcript.includes('åƒ') && amount < 1000) amount *= 1000;
                    if (transcript.includes('ä¸‡') && amount < 10000) amount *= 10000;
                }
                
                this.showConfirm({ 
                    transcript, 
                    date, 
                    project: matchedProject, 
                    type, 
                    amount: amount || 0, 
                    confidence: 'medium', 
                    reason: 'æœ¬åœ°æ™ºèƒ½åŒ¹é…' 
                });
            },

            showConfirm(result) {
                window.__voiceResult = result;
                let projectName = result.project ? result.project.name : 'âš ï¸ æœªåŒ¹é…é¡¹ç›®';
                let amountDisplay = result.amount ? 'Â¥' + formatNumber(result.amount) : 'æœªè¯†åˆ«';
                
                DOM.voiceConfirmContent.innerHTML = `
                    <div class="voice-result-item"><span>ğŸ—£ï¸ ä½ è¯´çš„</span><span style="color:#00d4aa;">"${result.transcript}"</span></div>
                    <div class="voice-match-hint"><i class="fas fa-robot" style="color:#00d4aa;"></i> ${result.reason || 'AIè¯­ä¹‰åŒ¹é…'}</div>
                    <div class="voice-result-item"><span>ğŸ“… è¯†åˆ«æ—¥æœŸ</span><span style="color:#00d4aa;">${result.date}</span></div>
                    <div class="voice-result-item"><span>ğŸ—ï¸ åŒ¹é…é¡¹ç›®</span><span style="color:#00d4aa;">${projectName}</span></div>
                    <div class="voice-result-item"><span>ğŸ·ï¸ åŒ¹é…ç±»å‹</span><span style="color:#00d4aa;">${result.type}</span></div>
                    <div class="voice-result-item"><span>ğŸ’° è¯†åˆ«é‡‘é¢</span><span style="color:${result.amount?'#00d4aa':'#ff6b6b'};">${amountDisplay}</span></div>
                `;
                DOM.voiceConfirmModal.classList.add('active');
            }
        };

        // ========== æ”¶æ¬¾èŠ‚ç‚¹ç®¡ç† ==========
        let currentMilestones = [];

        function calculateMilestoneTotal() {
            return currentMilestones.reduce((sum, m) => sum + m.amount, 0);
        }

        function updateMilestoneTotalDisplay() {
            const total = calculateMilestoneTotal();
            DOM.totalAmountDisplay.textContent = formatMoney(total);
            
            const budget = parseFloat(DOM.projectBudget.value) || 0;
            if (budget > 0 && Math.abs(total - budget) > 0.01) {
                DOM.milestoneWarning.style.display = 'block';
                DOM.milestoneWarning.innerHTML = `<i class="fas fa-exclamation-triangle"></i> æ”¶æ¬¾èŠ‚ç‚¹æ€»é¢ ${formatMoney(total)} ä¸åˆåŒæ€»é¢ ${formatMoney(budget)} ä¸ç¬¦`;
            } else {
                DOM.milestoneWarning.style.display = 'none';
            }
        }

        function renderMilestoneList() {
            DOM.milestoneList.innerHTML = '';
            if (currentMilestones.length === 0) {
                DOM.milestoneList.innerHTML = '<div style="color:#777; text-align:center; padding:20px;"><i class="fas fa-file-signature"></i><br>æš‚æ— æ”¶æ¬¾èŠ‚ç‚¹ï¼Œç‚¹å‡»"æ·»åŠ èŠ‚ç‚¹"è®¾ç½®</div>';
                updateMilestoneTotalDisplay();
                return;
            }
            
            currentMilestones.sort((a,b) => a.date.localeCompare(b.date)).forEach((milestone, index) => {
                const div = document.createElement('div');
                div.className = 'milestone-item';
                div.innerHTML = `
                    <div class="milestone-info">
                        <div class="milestone-date">ğŸ“… ${milestone.date} ${milestone.note ? `Â· ${milestone.note}` : ''}</div>
                        <div class="milestone-amount">ğŸ’° ${formatMoney(milestone.amount)}</div>
                    </div>
                    <div class="milestone-actions">
                        <button class="btn-remove-milestone" data-index="${index}">åˆ é™¤</button>
                    </div>
                `;
                DOM.milestoneList.appendChild(div);
            });
            
            document.querySelectorAll('.btn-remove-milestone').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    currentMilestones.splice(index, 1);
                    renderMilestoneList();
                    updateMilestoneTotalDisplay();
                });
            });
            
            updateMilestoneTotalDisplay();
        }

        // ========== è´¹ç”¨ç±»å‹æ ‡ç­¾ - æ‰‹åŠ¨é€‰æ‹©åŠŸèƒ½ ==========
        function renderCategoryTags() {
            DOM.categoryTags.innerHTML = '';
            
            const incomeTag = document.createElement('span');
            incomeTag.className = 'category-tag active'; 
            incomeTag.setAttribute('data-type', 'æ”¶å…¥'); 
            incomeTag.textContent = 'æ”¶å…¥';
            incomeTag.addEventListener('click', (e) => {
                e.preventDefault();
                setActiveCategory('æ”¶å…¥');
            });
            DOM.categoryTags.appendChild(incomeTag);
            
            AppState.expenseTypes.forEach(type => {
                const tag = document.createElement('span'); 
                tag.className = 'category-tag'; 
                tag.setAttribute('data-type', type); 
                tag.innerHTML = `${type} <span class="remove-tag" data-type="${type}">&times;</span>`;
                
                tag.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-tag')) {
                        e.stopPropagation();
                        return;
                    }
                    setActiveCategory(type);
                });
                
                const removeSpan = tag.querySelector('.remove-tag');
                removeSpan.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (AppState.expenseTypes.length > 1) { 
                        AppState.deleteExpenseType(type); 
                        renderCategoryTags(); 
                    } else {
                        alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªè´¹ç”¨ç±»å‹'); 
                    }
                });
                
                DOM.categoryTags.appendChild(tag);
            });
            
            setActiveCategory('æ”¶å…¥');
        }
        
        function setActiveCategory(type) {
            document.querySelectorAll('.category-tag').forEach(t => {
                t.classList.remove('active');
            });
            
            const activeTag = document.querySelector(`.category-tag[data-type="${type}"]`);
            if (activeTag) {
                activeTag.classList.add('active');
            }
            
            DOM.transactionType.value = type;
        }

        // é¡¹ç›®ä¸‹æ‹‰æ¡†
        function fillProjectSelect() {
            DOM.transactionProject.innerHTML = '<option value="">è¯·é€‰æ‹©é¡¹ç›®</option>' + 
                AppState.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        // è¡¨æ ¼åˆ‡æ¢
        function bindToggles() {
            DOM.summaryToggle.onclick = ()=>{
                DOM.summaryTable.style.display = 'table'; 
                DOM.projectsTable.style.display = 'none'; 
                DOM.transactionsTable.style.display = 'none';
                DOM.summaryToggle.classList.add('active'); 
                DOM.projectsToggle.classList.remove('active'); 
                DOM.transactionsToggle.classList.remove('active');
                DOM.tableTitle.innerText = 'ğŸ“‹ ç»¼åˆæŠ¥è¡¨';
            };
            DOM.projectsToggle.onclick = ()=>{
                DOM.summaryTable.style.display = 'none'; 
                DOM.projectsTable.style.display = 'table'; 
                DOM.transactionsTable.style.display = 'none';
                DOM.projectsToggle.classList.add('active'); 
                DOM.summaryToggle.classList.remove('active'); 
                DOM.transactionsToggle.classList.remove('active');
                DOM.tableTitle.innerText = 'ğŸ“ é¡¹ç›®åˆ—è¡¨';
            };
            DOM.transactionsToggle.onclick = ()=>{
                DOM.summaryTable.style.display = 'none'; 
                DOM.projectsTable.style.display = 'none'; 
                DOM.transactionsTable.style.display = 'table';
                DOM.transactionsToggle.classList.add('active'); 
                DOM.summaryToggle.classList.remove('active'); 
                DOM.projectsToggle.classList.remove('active');
                DOM.tableTitle.innerText = 'ğŸ’¸ æ”¶æ”¯è®°å½•';
            };
        }

        // ========== æ›´æ–°åº”æ”¶è´¦æ¬¾æ¨¡å— ==========
        function updateReceivableSection() {
            const analysis = AppState.getReceivableAnalysis();
            
            DOM.totalReceivable.textContent = formatMoney(analysis.totalReceivable);
            DOM.totalReceivableCount.textContent = `${analysis.items.filter(i => i.pendingAmount > 0).length}ç¬”å¾…æ”¶`;
            DOM.overdueAmount.textContent = formatMoney(analysis.overdueAmount);
            DOM.overdueCount.textContent = `${analysis.overdueCount}ç¬”é€¾æœŸ`;
            DOM.upcomingAmount.textContent = formatMoney(analysis.upcomingAmount);
            DOM.upcomingCount.textContent = `${analysis.upcomingCount}ç¬”7å¤©å†…åˆ°æœŸ`;
            
            if (analysis.items.length === 0) {
                DOM.receivableTableBody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fas fa-file-invoice-dollar"></i><br>æš‚æ— åº”æ”¶è´¦æ¬¾</td></tr>';
                return;
            }
            
            DOM.receivableTableBody.innerHTML = analysis.items.map(item => {
                let statusClass = '';
                let statusText = '';
                
                if (item.status === 'overdue') {
                    statusClass = 'status-overdue';
                    statusText = 'é€¾æœŸ';
                } else if (item.status === 'upcoming') {
                    statusClass = 'status-upcoming';
                    statusText = 'å³å°†åˆ°æœŸ';
                } else if (item.status === 'paid') {
                    statusClass = 'status-paid';
                    statusText = 'å·²ç»“æ¸…';
                } else {
                    statusClass = 'status-normal';
                    statusText = 'æ­£å¸¸';
                }
                
                const amountDisplay = item.pendingAmount > 0 ? formatMoney(item.pendingAmount) : 'å·²ç»“æ¸…';
                const amountClass = item.status === 'overdue' ? 'overdue' : (item.status === 'upcoming' ? 'upcoming' : '');
                
                return `<tr>
                    <td>${item.projectName}</td>
                    <td>${item.dueDate}</td>
                    <td>${formatMoney(item.originalAmount)}</td>
                    <td>${formatMoney(item.receivedAmount)}</td>
                    <td class="${amountClass}">${amountDisplay}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                </tr>`;
            }).join('');
        }

        // ========== âœ… ä¿®å¤2ï¼šå¼ºåˆ¶åˆ·æ–°æ‰€æœ‰UIç»„ä»¶ ==========
        function refreshUI() {
            console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰UIç»„ä»¶...');
            
            // 1. å¼ºåˆ¶é”€æ¯å¹¶é‡å»ºå›¾è¡¨
            if (profitChart) {
                profitChart.destroy();
                profitChart = null;
            }
            if (costPieChart) {
                costPieChart.destroy();
                costPieChart = null;
            }
            
            // 2. é‡æ–°ä»StorageåŠ è½½æœ€æ–°æ•°æ®ï¼ˆç¡®ä¿ä¸æ˜¯ç¼“å­˜ï¼‰
            AppState.projects = Storage.load('projects');
            AppState.transactions = Storage.load('transactions');
            AppState.expenseTypes = Storage.load('expenseTypes') || ['ææ–™è´¹', 'äººå·¥è´¹', 'å…¶ä»–è´¹ç”¨'];
            
            // 3. æ›´æ–°ä»ªè¡¨ç›˜
            const ov = AppState.getOverallStats();
            DOM.totalProjects.textContent = ov.totalProjects;
            DOM.totalIncome.textContent = formatMoney(ov.totalIncome);
            DOM.totalExpense.textContent = formatMoney(ov.totalExpense);
            DOM.totalProfit.textContent = (ov.totalProfit>=0?'':'') + formatMoney(Math.abs(ov.totalProfit));
            DOM.totalProfit.className = 'value ' + (ov.totalProfit>=0?'profit':'loss');

            // 4. æ›´æ–°ç»¼åˆæŠ¥è¡¨
            const stats = AppState.getAllStats();
            if (stats.length) {
                DOM.summaryBody.innerHTML = stats.map(s => `<tr>
                    <td>${s.name}</td>
                    <td>${formatMoney(s.contractTotal || 0)}</td>
                    <td>${formatMoney(s.income)}</td>
                    <td class="${(s.pendingIncome || 0) > 0 ? 'warning-cell' : 'profit-cell'}">${formatMoney(s.pendingIncome || 0)}</td>
                    <td>${formatMoney(s.expense)}</td>
                    <td class="${s.profit>=0?'profit-cell':'loss-cell'}">${s.profit>=0?'':'-'}${formatMoney(Math.abs(s.profit))}</td>
                    <td class="${s.profit>=0?'profit-cell':'loss-cell'}">${s.profitMargin.toFixed(1)}%</td>
                </tr>`).join('');
            } else { 
                DOM.summaryBody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-chart-line"></i><br>æš‚æ— é¡¹ç›®</td></tr>'; 
            }

            // 5. æ›´æ–°é¡¹ç›®åˆ—è¡¨
            if (AppState.projects.length) {
                DOM.projectsBody.innerHTML = AppState.projects.map(p => {
                    const stats = AppState.getProjectStats(p.id);
                    const milestoneCount = p.milestones ? p.milestones.length : 0;
                    
                    return `<tr>
                        <td>${p.name}</td>
                        <td>${formatMoney(p.budget || 0)}</td>
                        <td>${milestoneCount}ä¸ªèŠ‚ç‚¹</td>
                        <td>${formatMoney(stats?.income || 0)}</td>
                        <td class="${(stats?.pendingIncome || 0) > 0 ? 'warning-cell' : 'profit-cell'}">${formatMoney(stats?.pendingIncome || 0)}</td>
                        <td>${new Date(p.createdAt).toLocaleDateString()}</td>
                        <td><div class="action-buttons">
                            <button class="btn-edit" data-id="${p.id}" onclick="window.editProject(${p.id})">ç¼–è¾‘</button>
                            <button class="btn-delete" data-id="${p.id}" onclick="window.deleteProject(${p.id})">åˆ é™¤</button>
                        </div></td>
                    </tr>`;
                }).join('');
            } else { 
                DOM.projectsBody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-folder"></i><br>æš‚æ— é¡¹ç›®</td></tr>'; 
            }

            // 6. æ›´æ–°æ”¶æ”¯è®°å½•
            if (AppState.transactions.length) {
                const sorted = [...AppState.transactions].sort((a,b)=>b.date.localeCompare(a.date));
                DOM.transactionsBody.innerHTML = sorted.map(t => {
                    const proj = AppState.projects.find(p=>p.id===t.projectId);
                    return `<tr>
                        <td>${t.date}</td>
                        <td>${proj?.name||'æœªçŸ¥'}</td>
                        <td>${t.type}</td>
                        <td class="${t.type==='æ”¶å…¥'?'profit-cell':'loss-cell'}">${t.type==='æ”¶å…¥'?'+':'-'}${formatMoney(t.amount)}</td>
                        <td><div class="action-buttons">
                            <button class="btn-edit" data-id="${t.id}" onclick="window.editTransaction(${t.id})">ç¼–è¾‘</button>
                            <button class="btn-delete" data-id="${t.id}" onclick="window.deleteTransaction(${t.id})">åˆ é™¤</button>
                        </div></td>
                    </tr>`;
                }).join('');
            } else { 
                DOM.transactionsBody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="fas fa-exchange-alt"></i><br>æš‚æ— æ”¶æ”¯</td></tr>'; 
            }

            // 7. æ›´æ–°åº”æ”¶è´¦æ¬¾
            updateReceivableSection();
            
            // 8. é‡æ–°åˆ›å»ºå›¾è¡¨
            setTimeout(() => {
                updateCharts();
            }, 50);
            
            // 9. æ›´æ–°é¡¹ç›®ä¸‹æ‹‰æ¡†
            fillProjectSelect();
            
            console.log('âœ… UIåˆ·æ–°å®Œæˆ');
        }

        // ========== å›¾è¡¨æ›´æ–° ==========
        function updateCharts() {
            const ctxBar = document.getElementById('profitChart').getContext('2d');
            const ctxPie = document.getElementById('costPieChart').getContext('2d');
            const stats = AppState.getAllStats();
            
            if (!stats.length) {
                profitChart = new Chart(ctxBar, { 
                    type:'bar', 
                    data:{labels:['æ— æ•°æ®'], datasets:[{label:'åˆåŒæ€»é¢',data:[0],backgroundColor:'#444'}]}, 
                    options: { 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { labels: { color: '#ccc' } }, 
                            datalabels: { display: false } 
                        } 
                    } 
                });
                costPieChart = new Chart(ctxPie, { 
                    type:'pie', 
                    data:{labels:['æ— æ”¯å‡º'], datasets:[{data:[1],backgroundColor:['#555']}]}, 
                    options: { 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { labels: { color: '#ccc' } }, 
                            datalabels: { display: false } 
                        } 
                    } 
                });
                return;
            }
            
            profitChart = new Chart(ctxBar, {
                type:'bar', 
                data: {
                    labels: stats.map(s=>s.name),
                    datasets: [
                        { label:'åˆåŒæ€»é¢', data: stats.map(s=>s.contractTotal), backgroundColor:'#6c757d' },
                        { label:'å·²æ”¶', data: stats.map(s=>s.income), backgroundColor:'#00d4aa' },
                        { label:'æ”¯å‡º', data: stats.map(s=>s.expense), backgroundColor:'#ff6b6b' },
                        { label:'åˆ©æ¶¦', data: stats.map(s=>s.profit), type:'line', borderColor:'#ffd93d', backgroundColor:'transparent', tension:0.2 }
                    ]
                }, 
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { labels: { color: '#ccc' } },
                        datalabels: {
                            display: true,
                            color: '#fff',
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            formatter: (value) => value ? 'Â¥' + value.toFixed(0) : ''
                        }
                    }, 
                    scales: { 
                        y: { ticks: { callback: v => 'Â¥' + v }, grid: { color: '#333' } }, 
                        x: { ticks: { color: '#ccc' } } 
                    } 
                },
                plugins: [ChartDataLabels]
            });
            
            const costData = AppState.getCostTypeAnalysis();
            if (costData.length) {
                const total = costData.reduce((sum, item) => sum + item.amount, 0);
                costPieChart = new Chart(ctxPie, {
                    type: 'pie', 
                    data: {
                        labels: costData.map(c => c.type),
                        datasets: [{
                            data: costData.map(c => c.amount),
                            backgroundColor: ['#00d4aa','#ff6b6b','#ffd93d','#4dabf7','#9b5de5','#f15bb5'],
                            borderWidth: 0
                        }]
                    }, 
                    options: { 
                        maintainAspectRatio: false, 
                        plugins: { 
                            tooltip: { 
                                callbacks: { 
                                    label: (ctx) => `${ctx.label}: ${formatMoney(ctx.raw)} (${((ctx.raw/total)*100).toFixed(1)}%)` 
                                } 
                            },
                            legend: { 
                                labels: { color: '#ccc' },
                                position: 'bottom'
                            },
                            datalabels: {
                                display: true,
                                color: '#fff',
                                backgroundColor: 'rgba(0,0,0,0.6)',
                                borderRadius: 4,
                                padding: { top: 4, bottom: 4, left: 8, right: 8 },
                                formatter: (value, context) => {
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.chart.data.labels[context.dataIndex]}\n${formatMoney(value)} (${percentage}%)`;
                                },
                                font: { size: 11, weight: 'bold' }
                            }
                        } 
                    },
                    plugins: [ChartDataLabels]
                });
            } else {
                costPieChart = new Chart(ctxPie, { 
                    type:'pie', 
                    data:{labels:['æš‚æ— æ”¯å‡º'], datasets:[{data:[1],backgroundColor:['#555']}]}, 
                    options: { 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { labels: { color: '#ccc' } }, 
                            datalabels: { display: false } 
                        } 
                    } 
                });
            }
        }

        // ========== å…¨å±€å‡½æ•° ==========
        window.editProject = (id) => { 
            const p = AppState.projects.find(p => p.id === id); 
            if (!p) return;
            
            DOM.projectId.value = p.id; 
            DOM.projectName.value = p.name; 
            DOM.projectBudget.value = p.budget; 
            currentMilestones = p.milestones ? JSON.parse(JSON.stringify(p.milestones)) : [];
            renderMilestoneList();
            DOM.projectModalTitle.textContent = 'âœï¸ ç¼–è¾‘é¡¹ç›®'; 
            DOM.projectSubmitBtn.textContent = 'æ›´æ–°é¡¹ç›®';
            DOM.projectModal.classList.add('active');
        };
        
        window.deleteProject = (id) => { 
            if (confirm('åˆ é™¤é¡¹ç›®åŠæ‰€æœ‰æ”¶æ”¯ï¼Ÿ')) { 
                AppState.deleteProject(id); 
                refreshUI(); 
            } 
        };
        
        window.editTransaction = (id) => {
            const t = AppState.transactions.find(t => t.id === id);
            if (!t) return;
            
            DOM.transactionId.value = t.id; 
            DOM.transactionDate.value = t.date; 
            DOM.transactionProject.value = t.projectId;
            DOM.transactionAmount.value = t.amount; 
            setActiveCategory(t.type);
            DOM.transactionModalTitle.textContent = 'âœï¸ ç¼–è¾‘æ”¶æ”¯'; 
            DOM.transactionSubmitBtn.textContent = 'æ›´æ–°è®°å½•';
            DOM.transactionModal.classList.add('active');
        };
        
        window.deleteTransaction = (id) => { 
            if (confirm('åˆ é™¤è¿™ç¬”è®°å½•ï¼Ÿ')) { 
                AppState.deleteTransaction(id); 
                refreshUI(); 
            } 
        };

        // ========== âœ… ä¿®å¤3ï¼šåˆå§‹åŒ–æ‰€æœ‰æ—¥æœŸä¸ºå½“å¤© ==========
        function initDates() {
            const today = getTodayDate();
            console.log('ğŸ“… è®¾ç½®é»˜è®¤æ—¥æœŸä¸º:', today);
            
            // äº¤æ˜“æ—¥æœŸ
            if (DOM.transactionDate) {
                DOM.transactionDate.value = today;
            }
            
            // æ”¶æ¬¾èŠ‚ç‚¹æ—¥æœŸ
            if (DOM.milestoneDate) {
                DOM.milestoneDate.value = today;
            }
        }

        // ========== åˆå§‹åŒ– ==========
        function initApp() {
            console.log('ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–...');
            
            // è®¾ç½®æ‰€æœ‰æ—¥æœŸä¸ºå½“å¤©
            initDates();
            
            // è¯­éŸ³åˆå§‹åŒ–
            BailianAI.init();
            
            // è´¹ç”¨æ ‡ç­¾
            renderCategoryTags();

            // ç›‘å¬åˆåŒæ€»é¢å˜åŒ–
            DOM.projectBudget.addEventListener('input', updateMilestoneTotalDisplay);

            // âœ… é¡¹ç›®è¡¨å•æäº¤ - å®Œå…¨æ›¿æ¢æ—§æ•°æ® + å¼ºåˆ¶åˆ·æ–°
            DOM.projectForm.onsubmit = (e) => {
                e.preventDefault();
                
                const total = calculateMilestoneTotal();
                const budget = parseFloat(DOM.projectBudget.value) || 0;
                if (budget > 0 && Math.abs(total - budget) > 0.01) {
                    if (!confirm(`æ”¶æ¬¾èŠ‚ç‚¹æ€»é¢ ${formatMoney(total)} ä¸åˆåŒæ€»é¢ ${formatMoney(budget)} ä¸ç¬¦ï¼Œæ˜¯å¦ç»§ç»­ä¿å­˜ï¼Ÿ`)) {
                        return;
                    }
                }
                
                AppState.addProject(
                    DOM.projectId.value || null, 
                    DOM.projectName.value, 
                    DOM.projectBudget.value,
                    currentMilestones
                );
                
                DOM.projectModal.classList.remove('active'); 
                DOM.projectForm.reset(); 
                DOM.projectId.value = '';
                currentMilestones = [];
                renderMilestoneList();
                DOM.projectModalTitle.textContent = 'â• æ–°å»ºé¡¹ç›®'; 
                DOM.projectSubmitBtn.textContent = 'ä¿å­˜é¡¹ç›®';
                
                // å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰UI
                refreshUI();
            };

            // âœ… äº¤æ˜“è¡¨å•æäº¤ - å®Œå…¨æ›¿æ¢æ—§æ•°æ® + å¼ºåˆ¶åˆ·æ–°
            DOM.transactionForm.onsubmit = (e) => {
                e.preventDefault();
                
                AppState.addTransaction(
                    DOM.transactionId.value || null, 
                    DOM.transactionDate.value, 
                    DOM.transactionProject.value, 
                    DOM.transactionType.value, 
                    DOM.transactionAmount.value
                );
                
                DOM.transactionModal.classList.remove('active'); 
                DOM.transactionForm.reset(); 
                DOM.transactionId.value = '';
                initDates(); // é‡ç½®ä¸ºå½“å¤©
                setActiveCategory('æ”¶å…¥');
                DOM.transactionModalTitle.textContent = 'ğŸ’° æ”¶æ”¯è®°å½•'; 
                DOM.transactionSubmitBtn.textContent = 'ä¿å­˜è®°å½•';
                
                // å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰UI
                refreshUI();
            };

            // å…³é—­æ¨¡æ€æ¡†
            DOM.closeProjectModal.onclick = ()=> { 
                DOM.projectModal.classList.remove('active'); 
                DOM.projectForm.reset(); 
                DOM.projectId.value = ''; 
                currentMilestones = [];
                renderMilestoneList();
            };
            
            DOM.closeTransactionModal.onclick = ()=> { 
                DOM.transactionModal.classList.remove('active'); 
                DOM.transactionForm.reset(); 
                initDates(); // é‡ç½®ä¸ºå½“å¤©
                setActiveCategory('æ”¶å…¥'); 
            };
            
            DOM.closeMilestoneModal.onclick = ()=> { 
                DOM.milestoneModal.classList.remove('active'); 
                DOM.milestoneForm.reset(); 
                initDates(); // é‡ç½®ä¸ºå½“å¤©
            };
            
            DOM.closeVoiceConfirm.onclick = ()=> DOM.voiceConfirmModal.classList.remove('active');
            
            window.onclick = (e) => {
                if (e.target === DOM.projectModal) { 
                    DOM.projectModal.classList.remove('active'); 
                    DOM.projectForm.reset(); 
                    DOM.projectId.value = ''; 
                    currentMilestones = [];
                    renderMilestoneList();
                }
                if (e.target === DOM.transactionModal) { 
                    DOM.transactionModal.classList.remove('active'); 
                    DOM.transactionForm.reset(); 
                    initDates(); 
                    setActiveCategory('æ”¶å…¥'); 
                }
                if (e.target === DOM.milestoneModal) { 
                    DOM.milestoneModal.classList.remove('active'); 
                    DOM.milestoneForm.reset(); 
                    initDates(); 
                }
                if (e.target === DOM.voiceConfirmModal) DOM.voiceConfirmModal.classList.remove('active');
            };

            // æ·»åŠ é¡¹ç›®æŒ‰é’®
            DOM.addProjectBtn.onclick = ()=> { 
                DOM.projectModalTitle.textContent = 'â• æ–°å»ºé¡¹ç›®'; 
                DOM.projectSubmitBtn.textContent = 'ä¿å­˜é¡¹ç›®'; 
                DOM.projectId.value = ''; 
                DOM.projectName.value = ''; 
                DOM.projectBudget.value = ''; 
                currentMilestones = [];
                renderMilestoneList();
                DOM.projectModal.classList.add('active'); 
            };
            
            // æ·»åŠ äº¤æ˜“æŒ‰é’®
            DOM.addTransactionBtn.onclick = ()=> { 
                fillProjectSelect(); 
                DOM.transactionModalTitle.textContent = 'ğŸ’° æ”¶æ”¯è®°å½•'; 
                DOM.transactionSubmitBtn.textContent = 'ä¿å­˜è®°å½•'; 
                DOM.transactionId.value = ''; 
                initDates(); // è®¾ç½®ä¸ºå½“å¤©
                setActiveCategory('æ”¶å…¥'); 
                DOM.transactionModal.classList.add('active'); 
            };
            
            // è¯­éŸ³æŒ‰é’®
            DOM.voiceInputBtn.onclick = () => { 
                if (!AppState.projects.length) { 
                    alert('è¯·å…ˆæ·»åŠ é¡¹ç›®ï¼Œå†è¿›è¡Œè¯­éŸ³è®°è´¦'); 
                    return; 
                }
                BailianAI.start(); 
            };

            // è¯­éŸ³ç¡®è®¤æŒ‰é’®
            DOM.modifyBtn.onclick = ()=> { 
                DOM.voiceConfirmModal.classList.remove('active'); 
                if (window.__voiceResult) {
                    fillProjectSelect();
                    DOM.transactionDate.value = window.__voiceResult.date;
                    if (window.__voiceResult.project) {
                        DOM.transactionProject.value = window.__voiceResult.project.id;
                    }
                    DOM.transactionAmount.value = window.__voiceResult.amount || '';
                    setActiveCategory(window.__voiceResult.type || 'å…¶ä»–è´¹ç”¨');
                }
            };
            
            DOM.confirmBtn.onclick = ()=> {
                if (!window.__voiceResult || !window.__voiceResult.project) { 
                    alert('é¡¹ç›®æ— æ•ˆï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©'); 
                    return; 
                }
                if (!window.__voiceResult.amount || window.__voiceResult.amount <= 0) { 
                    alert('é‡‘é¢æ— æ•ˆï¼Œè¯·æ‰‹åŠ¨è¾“å…¥æˆ–é‡æ–°è¯­éŸ³'); 
                    return; 
                }
                
                AppState.addTransaction(
                    null, 
                    window.__voiceResult.date, 
                    window.__voiceResult.project.id, 
                    window.__voiceResult.type, 
                    window.__voiceResult.amount
                );
                
                DOM.voiceConfirmModal.classList.remove('active');
                DOM.transactionModal.classList.remove('active');
                
                // å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰UI
                refreshUI();
                
                DOM.voiceStatus.innerHTML = 'âœ… è¯­éŸ³è®°è´¦æˆåŠŸï¼';
                setTimeout(() => { 
                    DOM.voiceStatus.innerHTML = 'âœ¨ ç‚¹å‡»éº¦å…‹é£ï¼ŒAIæ™ºèƒ½è¯­ä¹‰åŒ¹é…'; 
                }, 3000);
            };

            // æ”¶æ¬¾èŠ‚ç‚¹ç®¡ç†
            DOM.addMilestoneBtn.onclick = () => {
                DOM.milestoneModal.classList.add('active');
            };
            
            DOM.milestoneForm.onsubmit = (e) => {
                e.preventDefault();
                const milestone = {
                    date: DOM.milestoneDate.value,
                    amount: parseFloat(DOM.milestoneAmount.value),
                    note: DOM.milestoneNote.value.trim() || ''
                };
                currentMilestones.push(milestone);
                renderMilestoneList();
                DOM.milestoneModal.classList.remove('active');
                DOM.milestoneForm.reset();
                initDates(); // é‡ç½®ä¸ºå½“å¤©
            };

            // è‡ªå®šä¹‰è´¹ç”¨ç±»å‹
            DOM.addCategoryBtn.onclick = ()=>{ 
                const val = DOM.customCategory.value.trim();
                if (val) { 
                    AppState.addExpenseType(val); 
                    renderCategoryTags(); 
                    DOM.customCategory.value = ''; 
                    setActiveCategory(val); 
                } 
            };
            
            // å¯¼å‡ºExcel
            DOM.exportBtn.onclick = exportToExcel;

            bindToggles();
            fillProjectSelect();
            
            // é¦–æ¬¡åˆ·æ–°UI
            refreshUI();
            
            console.log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
